<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéØ Smart Matcher + –†–µ–¥–∞–∫—Ç–æ—Ä —Å–∏–Ω–æ–Ω–∏–º–æ–≤</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
/* ===== RESET ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== BODY & BACKGROUND ===== */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #4f8ef7 0%, #7c3aed 55%, #a21caf 100%);
  min-height: 100vh;
  padding: 0 0 40px 0;
  color: #1c1c1e;
}

/* ===== GLOBAL NAV ===== */
.global-nav {
  position: sticky;
  top: 0;
  z-index: 5000;
  background: linear-gradient(90deg, #3b6fd4 0%, #6d28d9 60%, #9c1ac4 100%);
  box-shadow: 0 4px 20px rgba(80,0,120,0.35);
}
.global-nav__inner {
  max-width: 100%;
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  min-height: 52px;
}
.global-nav__brand {
  text-decoration: none;
  font-weight: 800;
  font-size: 17px;
  color: #ffffff;
  white-space: nowrap;
  letter-spacing: -0.3px;
  text-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.global-nav__links { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
.global-nav__link {
  text-decoration: none;
  font-size: 13px;
  font-weight: 650;
  color: rgba(255,255,255,0.88);
  background: rgba(255,255,255,0.13);
  border: 1px solid rgba(255,255,255,0.22);
  padding: 7px 14px;
  border-radius: 999px;
  white-space: nowrap;
  transition: transform .12s ease, background .12s ease;
}
.global-nav__link:hover { transform: translateY(-1px); background: rgba(255,255,255,0.24); color: #fff; }
.global-nav__link.is-active { color: #6d28d9; background: #ffffff; border-color: #ffffff; font-weight: 700; }

/* ===== MAIN WRAPPER ===== */
.main-wrapper { max-width: 100%; margin: 16px 16px 0; display: flex; flex-direction: column; gap: 14px; }

/* ===== SHARED JSON TOP BAR ===== */
.json-topbar {
  background: white;
  border-radius: 18px;
  padding: 14px 20px;
  box-shadow: 0 8px 40px rgba(80,0,120,0.22);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.json-topbar__title {
  font-size: 14px;
  font-weight: 800;
  color: #6d28d9;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.json-topbar__sep { width: 1px; height: 28px; background: #ddd6fe; flex-shrink: 0; }
.json-load-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #7c3aed;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.json-load-btn:hover { background: #6d28d9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(124,58,237,0.4); }
.json-status {
  font-size: 12px;
  color: #8e8e93;
  white-space: nowrap;
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
}
.json-status.ok { color: #34c759; font-weight: 600; }
.json-status.err { color: #ff3b30; font-weight: 600; }
.json-save-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
  color: white;
  border: none;
  padding: 8px 18px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.json-save-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(52,199,89,0.45); }
.json-html-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%);
  color: white;
  border: none;
  padding: 8px 18px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.json-html-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(109,40,217,0.45); }
.json-changes-badge {
  background: #ff9500;
  color: white;
  padding: 2px 9px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  display: none;
}
.json-changes-badge.show { display: inline-block; }

/* ===== COLLAPSIBLE SECTION ===== */
.section-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 8px 40px rgba(80,0,120,0.22);
  overflow: hidden;
}
.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  cursor: pointer;
  user-select: none;
  background: #faf8ff;
  border-bottom: 2px solid #f0ebff;
  transition: background 0.15s;
}
.section-header:hover { background: #f3f0ff; }
.section-header.collapsed { border-bottom-color: transparent; }
.section-title {
  font-size: 17px;
  font-weight: 800;
  color: #1c1c1e;
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.3px;
}
.section-badge {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  color: white;
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
}
.section-toggle {
  font-size: 18px;
  color: #a78bfa;
  transition: transform 0.25s;
  line-height: 1;
}
.section-toggle.rotated { transform: rotate(180deg); }
.section-body {
  padding: 20px;
  transition: all 0.25s;
}
.section-body.hidden { display: none; }

/* ===== SMART MATCHER styles ===== */
.version-badge {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
}
.algo-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.algo-badge {
  background: #f5f3ff;
  color: #6d28d9;
  padding: 3px 9px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid #ddd6fe;
}

/* Upload panel */
.upload-panel { margin-bottom: 16px; }
.upload-grid { display: flex; gap: 10px; align-items: stretch; }
.upload-box {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  border: 2px dashed #a78bfa;
  border-radius: 12px;
  padding: 12px 14px;
  transition: all 0.25s;
  cursor: pointer;
  background: #faf8ff;
}
.upload-box:hover { border-color: #7c3aed; background: #f5f3ff; }
.upload-box.loaded { border-color: #34c759; background: #f0fdf4; }
.upload-icon { font-size: 24px; flex-shrink: 0; line-height: 1; }
.upload-info { flex: 1; min-width: 0; }
.upload-title { font-size: 13px; font-weight: 700; color: #1c1c1e; margin-bottom: 2px; }
.upload-desc { font-size: 11px; color: #8e8e93; line-height: 1.3; }
.upload-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; flex-shrink: 0; }
.format-badges { display: flex; gap: 4px; }
.format-badge { background: #f5f3ff; color: #7c3aed; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 700; border: 1px solid #ddd6fe; }
.upload-btn {
  background: #7c3aed;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 9px;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.upload-btn:hover { background: #6d28d9; transform: translateY(-1px); }
.upload-status { font-size: 11px; color: #34c759; font-weight: 600; white-space: nowrap; text-align: right; }
input[type="file"] { display: none; }

/* Stats bar */
.stats-bar {
  background: #faf8ff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1.5px solid #ddd6fe;
  display: none;
}
.stats-bar.show { display: block; }
.stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
.stat-item {
  text-align: center;
  padding: 12px;
  border-radius: 12px;
  transition: all 0.2s;
  cursor: pointer;
  border: 2px solid transparent;
}
.stat-item:hover { background: #f5f3ff; border-color: #7c3aed; transform: translateY(-2px); }
.stat-item.active { background: #f5f3ff; border-color: #7c3aed; }
.stat-value { font-size: 30px; font-weight: 700; color: #7c3aed; margin-bottom: 4px; }
.stat-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; font-weight: 600; }

/* Progress */
.progress-bar { display: none; margin-bottom: 16px; }
.progress-bar.show { display: block; }
.progress-text { font-size: 14px; color: #1c1c1e; margin-bottom: 10px; font-weight: 600; text-align: center; }
.progress-track { height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #6d28d9 0%, #7c3aed 100%); transition: width 0.3s; width: 0%; }

/* Results panel */
.results-panel { display: none; }
.results-panel.show { display: block; }
.results-header { margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid #f0ebff; }
.results-title { font-size: 18px; font-weight: 600; color: #1c1c1e; }
.results-subtitle { font-size: 13px; color: #8e8e93; margin-top: 4px; }
.results-list { height: 560px; overflow-y: auto; padding-right: 4px; }
.results-list::-webkit-scrollbar { width: 6px; }
.results-list::-webkit-scrollbar-track { background: #f5f3ff; border-radius: 4px; }
.results-list::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 4px; }

/* Audit results scroll */

/* Editor groups scroll */
#groupsContainer { max-height: 560px; overflow-y: auto; padding-right: 4px; }
#groupsContainer::-webkit-scrollbar { width: 6px; }
#groupsContainer::-webkit-scrollbar-track { background: #f5f3ff; border-radius: 4px; }
#groupsContainer::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 4px; }

/* Result cards */
/* ===== RESULT CARDS ‚Äî compact row-based diff ===== */
.result-card {
  border: 1.5px solid #ddd6fe;
  border-radius: 12px;
  padding: 10px 12px;
  margin-bottom: 7px;
  transition: all 0.15s;
  cursor: pointer;
  background: #fff;
}
.result-card:hover { border-color: #7c3aed; box-shadow: 0 3px 10px rgba(124,58,237,0.12); transform: translateY(-1px); }
.result-card.high-match  { border-color: #34c759; background: #f8fff9; }
.result-card.medium-match{ border-color: #ff9500; background: #fffcf5; }
.result-card.skipped-card{ border-color: #c4b5fd; background: #f9f8ff; opacity:.85; }
.result-card.review-card { border-color: #af52de; background: #fdf8ff; }

.card-header { display:flex; align-items:center; gap:6px; margin-bottom:7px; flex-wrap:wrap; }
.card-left { display:flex; align-items:center; gap:5px; flex:1; min-width:0; }
.similarity-badge { display:inline-flex; align-items:center; padding:2px 8px; border-radius:9px; font-size:12px; font-weight:800; color:white; flex-shrink:0; }
.similarity-high   { background:#34c759; }
.similarity-medium { background:#ff9500; }
.similarity-skip   { background:#a78bfa; }
.similarity-review { background:#af52de; }
.match-tags { display:flex; gap:3px; flex-wrap:wrap; }
.match-tag { background:#f5f3ff; color:#7c3aed; padding:2px 6px; border-radius:6px; font-size:10px; font-weight:600; border:1px solid #ddd6fe; }
.action-badge { padding:2px 9px; border-radius:9px; font-size:11px; font-weight:700; flex-shrink:0; white-space:nowrap; }
.action-synonym { background:#ff9500; color:white; }
.action-main    { background:#7c3aed; color:white; }
.action-skip    { background:#a78bfa; color:white; }
.action-review  { background:#af52de; color:white; }
.action-merge   { background:#0ea5e9; color:white; }

/* comparison table ‚Äî 2 rows stacked */
.cmp-table { width:100%; border-collapse:collapse; table-layout:fixed; }
.cmp-table td { padding:4px 6px; vertical-align:middle; overflow:hidden; }
.cmp-table tr.cmp-row1 { border-bottom:1px dashed #ede9fe; }
.cmp-col-src  { width:150px; }
.cmp-col-name { }
.cmp-col-bc   { width:128px; text-align:right; }
.cmp-src-label { font-size:10px; font-weight:700; color:#8e8e93; text-transform:uppercase; letter-spacing:.3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block; }
.cmp-row1 .cmp-src-label { color:#ff9500; }
.cmp-row2 .cmp-src-label { color:#34c759; }
.cmp-name-text { font-size:13px; font-weight:700; color:#1c1c1e; line-height:1.3; text-transform:uppercase; word-break:break-word; }
.cmp-bc-text { font-family:'Courier New',monospace; font-size:11px; font-weight:700; color:#7c3aed; }

/* diff highlights */
.tok-match { background:#d1fadf; color:#166534; border-radius:3px; padding:0 2px; font-weight:800; }
.tok-diff  { background:#ffe4ec; color:#be123c; border-radius:3px; padding:0 2px; }
.highlight { background:#d1fadf; padding:0 2px; border-radius:3px; font-weight:800; color:#166534; }

.score-details { margin-top:6px; padding-top:5px; border-top:1px solid #ede9fe; font-size:10px; color:#8e8e93; display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.score-item { display:inline-flex; align-items:center; gap:3px; background:#f5f3ff; padding:2px 6px; border-radius:5px; }
.score-icon { font-size:10px; }

.candidates-section { margin-top:7px; border-top:1px dashed #ddd6fe; padding-top:7px; }
.candidates-title { font-size:10px; font-weight:700; color:#8e8e93; text-transform:uppercase; margin-bottom:5px; }
.candidate-item { display:flex; align-items:center; gap:6px; padding:5px 8px; border-radius:8px; margin-bottom:4px; cursor:pointer; border:1.5px solid transparent; transition:all 0.15s; background:#f5f3ff; }
.candidate-item:hover { border-color:#7c3aed; background:#ede9fe; }
.candidate-item.selected { border-color:#34c759; background:#f0fdf4; }
.candidate-score { font-size:11px; font-weight:700; color:white; padding:1px 6px; border-radius:6px; min-width:34px; text-align:center; flex-shrink:0; }
.candidate-name { font-size:12px; font-weight:600; color:#1c1c1e; flex:1; text-transform:uppercase; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.candidate-src  { font-size:9px; color:#a78bfa; white-space:nowrap; flex-shrink:0; }
.candidate-bc   { font-size:10px; color:#7c3aed; font-family:monospace; flex-shrink:0; }
.select-candidate-btn { background:#7c3aed; color:white; border:none; padding:3px 8px; border-radius:6px; font-size:10px; font-weight:700; cursor:pointer; flex-shrink:0; }
.select-candidate-btn:hover { background:#6d28d9; }

.matcher-empty { text-align:center; padding:50px 20px; color:#8e8e93; }
.matcher-empty-icon { font-size:52px; margin-bottom:12px; }

.skip-reason-box { border-radius:8px; padding:6px 10px; margin-bottom:7px; font-size:11px; font-weight:700; display:flex; flex-direction:column; gap:3px; }
.skip-reason-box.is-main    { background:#f5f3ff; border:1px solid #c4b5fd; color:#6d28d9; }
.skip-reason-box.is-synonym { background:#fdf4ff; border:1px solid #e9d5ff; color:#7b1fa2; }
.skip-reason-detail { font-size:10px; font-weight:400; opacity:.85; font-family:monospace; word-break:break-all; }
.tag-rebrand { background:#fff3e0; color:#bf360c; border:1px solid #ffb74d; padding:1px 6px; border-radius:6px; font-size:10px; font-weight:700; }
.weight-warning { display:inline-flex; align-items:center; gap:4px; background:#fff3cd; border:1px solid #ffc107; border-radius:5px; padding:2px 6px; font-size:10px; color:#856404; font-weight:600; }

/* ===== EDITOR styles ===== */
.editor-topbar {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 10px 12px;
  border: 1px solid #ddd6fe;
  border-radius: 14px;
  background: #f5f3ff;
  margin-bottom: 14px;
}
.editor-controls { display: flex; gap: 6px; flex-wrap: nowrap; margin: 0; flex: 0 0 auto; }
.btn {
  padding: 7px 12px;
  border: none;
  border-radius: 9px;
  cursor: pointer;
  font-weight: 700;
  font-size: 12px;
  transition: all 0.18s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  line-height: 1;
  white-space: nowrap;
  user-select: none;
  height: 32px;
}
.btn-primary { background: #1a73e8; color: white; }
.btn-primary:hover { background: #1558c0; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(26,115,232,0.35); }
.btn-success { background: #1a73e8; color: white; }
.btn-success:hover { background: #1558c0; transform: translateY(-1px); box-shadow: 0 3px 10px rgba(26,115,232,0.35); }
.btn-warning { background: #ff9500; color: white; }
.btn-warning:hover { background: #e08600; transform: translateY(-1px); }
.btn-danger { background: #e11d48; color: white; }
.btn-danger:hover { background: #be123c; transform: translateY(-1px); }
.btn-secondary { background: #ffffff; color: #1a73e8; border: 1.5px solid #c4b5fd; }
.btn-secondary:hover { background: #ede9fe; border-color: #7c3aed; color: #7c3aed; }
.btn:disabled { background: #e5e5ea; color: #aeaeb2; cursor: not-allowed; transform: none; box-shadow: none; border-color: #e5e5ea; }

/* Info cards */
.editor-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 14px; }
.info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 14px; padding: 12px 16px; color: white; }
.info-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.info-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.info-card:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.info-value { font-size: 22px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.5px; }
.info-label { font-size: 11px; opacity: 0.9; font-weight: 500; }

/* Search */
.search-wide {
  width: 100%;
  padding: 10px 14px;
  border: 2px solid #c4b5fd;
  border-radius: 12px;
  font-size: 14px;
  font-family: inherit;
  background: #faf8ff;
  transition: all 0.2s;
  margin: 0 0 14px;
}
.search-wide:focus { outline: none; border-color: #7c3aed; background: #f3f0ff; box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }

/* Grid */
.rows-wrap { width: 100%; overflow-x: auto; }
.editor-grid {
  display: grid;
  grid-template-columns: 1.2fr 0.9fr 2fr 1.1fr 44px 110px;
  gap: 8px;
  align-items: center;
  min-width: 1180px;
}
.editor-grid > * { min-width: 0; }

/* Inputs */
.inp { height: 28px; padding: 1px 10px; border: 1.5px solid #c4b5fd; border-radius: 8px; font-size: 12px; font-family: inherit; background: #faf8ff; min-width: 0; transition: all 0.15s; }
.inp:focus { outline: none; border-color: #7c3aed; background: #f3f0ff; box-shadow: 0 0 0 2px rgba(124,58,237,0.1); }
.inp-mono { font-family: "Courier New", monospace; font-weight: 700; letter-spacing: 0.2px; }
.inp-name { font-weight: 400; }

/* Barcode cell */
.main-cell { display: flex; align-items: center; gap: 6px; min-width: 0; }
.main-cell .inp { flex: 1 1 auto; min-width: 0; }
.loupe-link {
  width: 24px; min-width: 24px; height: 24px;
  display: inline-flex; align-items: center; justify-content: center;
  border: 1px solid #c4b5fd; border-radius: 8px;
  background: #f5f3ff; color: #7c3aed;
  text-decoration: none; font-size: 12px; line-height: 1; user-select: none;
}
.loupe-link:hover { background: #ede9fe; border-color: #7c3aed; }

/* Synonyms cell */
.synonyms-cell {
  display: flex; gap: 6px; align-items: center;
  flex-wrap: nowrap; overflow-x: auto;
  padding: 1px 2px; height: 28px; width: 100%; min-width: 0;
}
.synonym-pill {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 2px 10px; height: 22px;
  background: #ede9fe; border: 1px solid #c4b5fd; border-radius: 999px;
  font-size: 12px; font-family: "Courier New", monospace;
  white-space: nowrap; flex: 0 0 auto; color: #1c1c1e;
}
.synonym-pill.syn-link { cursor: pointer; }
.synonym-pill.syn-link:hover { background: #ddd6fe; border-color: #a78bfa; }
.editor-row.has-conflict .synonym-pill { background: #ffe6e6; border-color: #e11d48; }
.synonym-remove { border: none; background: none; color: #e11d48; cursor: pointer; font-size: 14px; line-height: 1; padding: 0; height: 16px; }
.synonym-remove:hover { color: #be123c; }

/* Row buttons */
.btn-disk { width: 44px; min-width: 44px; padding: 0; justify-content: center; border-radius: 9px; height: 28px; font-size: 13px; font-weight: 700; }
.btn-del { height: 28px; border-radius: 9px; padding: 0 10px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 11px; }

/* New group card */
.new-group { background: #f5f3ff; border: 2px dashed #a78bfa; border-radius: 16px; padding: 12px; margin-bottom: 12px; transition: all 0.2s; }
.new-group:hover { border-color: #7c3aed; }

/* Group rows */
.editor-row { background: #faf8ff; border-radius: 14px; padding: 8px 12px; border: 1.5px solid #ddd6fe; transition: all .15s; margin-bottom: 8px; }
.editor-row:hover { border-color: #a78bfa; background: #f5f3ff; }
.editor-row.has-conflict { border-color: #e11d48; background: #fff5f5; }

/* Editor empty state */
.editor-empty { text-align: center; padding: 40px 20px; color: #8e8e93; }
.editor-empty-icon { font-size: 48px; margin-bottom: 12px; }
.editor-empty h3 { font-size: 18px; font-weight: 600; margin-bottom: 6px; color: #1c1c1e; }
.editor-empty p { font-size: 13px; }

/* ===== MODAL ===== */
.modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(80,0,120,0.35); z-index: 1000;
  display: none; align-items: center; justify-content: center; padding: 16px;
}
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 16px; max-width: 520px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 16px 48px rgba(80,0,120,0.28); }
.modal-header { padding: 12px 16px; border-bottom: 1px solid #ddd6fe; display: flex; justify-content: space-between; align-items: center; background: #f5f3ff; border-radius: 16px 16px 0 0; }
.modal-title { font-size: 14px; font-weight: 700; color: #6d28d9; }
.modal-close { background: none; border: none; font-size: 20px; color: #8e8e93; cursor: pointer; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.15s; }
.modal-close:hover { background: #ede9fe; color: #7c3aed; }
.modal-body { padding: 14px 16px; }

/* action banner */
.action-info-compact { border-radius: 8px; padding: 8px 12px; margin-bottom: 12px; font-size: 12px; font-weight: 700; border-left: 3px solid #ffc107; background: #fff9e6; color: #856404; }
.action-info-compact.main { background: #f5f3ff; border-left-color: #7c3aed; color: #6d28d9; }
.action-info-compact.merge { background: #e0f2fe; border-left-color: #0ea5e9; color: #075985; }

/* sim row */
.modal-sim-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.modal-sim-pct { font-size: 22px; font-weight: 800; color: white; background: #34c759; border-radius: 10px; padding: 4px 12px; flex-shrink: 0; }
.modal-sim-pct.med { background: #ff9500; }
.modal-sim-pct.low { background: #af52de; }

/* two-column in modal */
.modal-cmp { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px; }
.modal-col { background: #f8f7ff; border-radius: 8px; padding: 8px 10px; border-left: 3px solid #7c3aed; }
.modal-col.col-price { border-left-color: #ff9500; }
.modal-col.col-json  { border-left-color: #34c759; }
.modal-col-src { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #a78bfa; margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.modal-col-bc { font-family: monospace; font-size: 11px; font-weight: 700; color: #7c3aed; margin-bottom: 3px; }
.modal-col-name { font-size: 12px; font-weight: 700; color: #1c1c1e; text-transform: uppercase; line-height: 1.3; word-break: break-word; }
.modal-col-norm { font-size: 9px; color: #aaa; font-family: monospace; margin-top: 3px; word-break: break-word; }

.modal-actions { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; padding: 12px 16px; border-top: 1px solid #ddd6fe; }
.modal-btn { padding: 10px; border: none; border-radius: 9px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
.modal-btn.cancel { background: #f5f3ff; color: #7c3aed; border: 1.5px solid #ddd6fe; }
.modal-btn.cancel:hover { background: #ede9fe; }
.modal-btn.confirm { background: #34c759; color: white; }
.modal-btn.confirm:hover { background: #28a745; transform: translateY(-1px); }

/* similarity-info-compact (legacy compat) */
.similarity-info-compact { display: none; }
.similarity-percent-compact { display: none; }
.similarity-text-compact { display: none; }
.product-compact { display: none; }


/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .upload-grid { flex-direction: column; }
  .stats-grid { grid-template-columns: repeat(2,1fr) !important; }
  .modal-actions { grid-template-columns: 1fr; }
  .main-wrapper { margin: 10px 8px 0; }
}
:root { --global-nav-h: 52px; }
  </style>
</head>

<body>
<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</a>
    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">–†–µ–¥–∞–∫—Ç–æ—Ä JSON</a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">–û–±—Ä–µ–∑–∞—Ç–µ–ª—å</a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">–ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</a>
    </nav>
  </div>
</header>

<div class="main-wrapper">

  <!-- ========== SHARED JSON TOP BAR ========== -->
  <div class="json-topbar">
    <div class="json-topbar__title">üì¶ –ë–∞–∑–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div>
    <span style="font-size:11px;color:#a78bfa;font-weight:600;">—Ç–æ–ª—å–∫–æ JSON</span>
    <div class="json-topbar__sep"></div>
    <button class="json-load-btn" onclick="document.getElementById('globalJsonInput').click()">
      üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON
    </button>
    <input type="file" id="globalJsonInput" accept=".json">
    <span class="json-status" id="globalJsonStatus">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</span>
    <span class="json-changes-badge" id="globalChangesBadge">0 –∏–∑–º.</span>
    <button class="json-save-btn" id="globalSaveBtn" onclick="saveSharedData()">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON
    </button>
    <button class="json-html-btn" onclick="saveAsHtml()">
      üìÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    </button>
  </div>

  <!-- ========== SECTION 1: –ü–û–ò–°–ö –ù–û–í–´–• –ì–†–£–ü–ü –ò –°–ò–ù–û–ù–ò–ú–û–í ========== -->
  <div class="section-card">
    <div class="section-header collapsed" id="matcherHeader" onclick="toggleSection('matcher')">
      <div class="section-title">
        üéØ –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –≥—Ä—É–ø–ø –∏ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
        <span class="section-badge">V4.1</span>
      </div>
      <div style="flex:1;"></div>
      <div class="section-toggle" id="matcherToggle">‚ñ≤</div>
    </div>
    <div class="section-body hidden" id="matcherBody">

      <!-- Multi-file upload + JSON status -->
      <div class="upload-panel">
        <div class="upload-grid">
          <div class="upload-box" id="multiPriceBox" onclick="document.getElementById('multiPriceInput').click()">
            <div class="upload-icon">üìÇ</div>
            <div class="upload-info">
              <div class="upload-title">–ü—Ä–∞–π—Å—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</div>
              <div class="upload-desc">CSV / XLSX ¬∑ –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤</div>
              <div class="upload-status" id="multiPriceStatus"></div>
            </div>
            <div class="upload-right">
              <div class="format-badges">
                <span class="format-badge">CSV</span>
                <span class="format-badge">XLSX</span>
              </div>
              <button class="upload-btn">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
            </div>
            <input type="file" id="multiPriceInput" accept=".csv,.xlsx,.xls" multiple>
          </div>
          <div class="upload-box" id="jsonStatusBox" style="cursor:default;max-width:220px;flex:0 0 auto;">
            <div class="upload-icon">üì¶</div>
            <div class="upload-info">
              <div class="upload-title">–ë–∞–∑–∞ JSON</div>
              <div class="upload-status" id="matcherJsonStatus" style="margin-top:4px;font-size:11px;color:#8e8e93;">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>
              <div style="font-size:10px;color:#a78bfa;margin-top:2px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON –≤ –ø–∞–Ω–µ–ª–∏ –≤—ã—à–µ</div>
            </div>
          </div>
        </div>
        <!-- –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã -->
        <div id="priceFilesList" style="display:none;margin-top:10px;padding:0 4px;"></div>
      </div>

      <div class="progress-bar" id="progressBar">
        <div class="progress-text" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="stats-bar" id="statsBar">
        <div class="stats-grid" style="grid-template-columns: repeat(4,1fr);">
          <div class="stat-item active" onclick="filterByView('all')" data-view="all">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">üìã –í—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è</div>
          </div>
          <div class="stat-item" onclick="filterByView('samebc')" data-view="samebc">
            <div class="stat-value" id="statSameBC">0</div>
            <div class="stat-label">üîÅ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –®–ö</div>
          </div>
          <div class="stat-item" onclick="filterByView('known')" data-view="known">
            <div class="stat-value" id="statKnown">0</div>
            <div class="stat-label">üîó –£–∂–µ –≤ –±–∞–∑–µ JSON</div>
          </div>
          <div class="stat-item" onclick="filterByView('added')" data-view="added">
            <div class="stat-value" id="statAdded">0</div>
            <div class="stat-label">‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ</div>
          </div>
        </div>
      </div>

      <div class="results-panel" id="resultsPanel">
        <div class="results-header">
          <div class="results-title" id="resultsTitle">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Ç—á–∏–Ω–≥–∞</div>
          <div class="results-subtitle" id="resultsSubtitle"></div>
        </div>
        <div class="results-list" id="resultsList">
          <div class="matcher-empty">
            <div class="matcher-empty-icon">üîç</div>
            <div style="font-size:18px;font-weight:600;margin-bottom:8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å—ã</div>
            <div>–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–π—Å–æ–≤ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—ã –≤ JSON –±–∞–∑—É</div>
          </div>
        </div>
      </div>

    </div><!-- /matcherBody -->
  </div><!-- /section-card -->

  <!-- ========== SECTION 2: EDITOR ========== -->
  <div class="section-card">
    <div class="section-header collapsed" id="editorHeader" onclick="toggleSection('editor')">
      <div class="section-title">üîó –†–µ–¥–∞–∫—Ç–æ—Ä —Å–∏–Ω–æ–Ω–∏–º–æ–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</div>
      <div class="section-toggle" id="editorToggle">‚ñ≤</div>
    </div>
    <div class="section-body hidden" id="editorBody">

      <!-- Editor toolbar (Excel controls only, JSON is global) -->
      <div class="editor-topbar">
        <div class="editor-controls">
          <button id="exportExcelBtn" class="btn btn-secondary" disabled title="–°–∫–∞—á–∞—Ç—å Excel">üìä Excel</button>
          <button id="importExcelBtn" class="btn btn-secondary" title="–ò–º–ø–æ—Ä—Ç Excel">üì• Excel</button>
          <button id="clearBtn" class="btn btn-danger" disabled title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
          <input type="file" id="excelImportInput" accept=".xlsx,.xls" style="display:none;">
        </div>
      </div>

      <div id="editorInfoPanel" class="editor-info-grid" style="display:none;">
        <div class="info-card"><div class="info-value" id="groupCount">0</div><div class="info-label">–ì—Ä—É–ø–ø</div></div>
        <div class="info-card"><div class="info-value" id="synonymCount">0</div><div class="info-label">–°–∏–Ω–æ–Ω–∏–º–æ–≤</div></div>
        <div class="info-card"><div class="info-value" id="barcodeCount">0</div><div class="info-label">–®–ö —É–Ω–∏–∫.</div></div>
        <div class="info-card"><div class="info-value" id="conflictCount">0</div><div class="info-label">–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</div></div>
      </div>

      <input type="text" id="searchInput" class="search-wide" placeholder="–ü–æ–∏—Å–∫ –ø–æ –®–ö / –Ω–∞–∑–≤–∞–Ω–∏—é / —Å–∏–Ω–æ–Ω–∏–º–∞–º..." disabled>

      <!-- New group -->
      <div class="new-group">
        <div class="rows-wrap">
          <div class="editor-grid">
            <input class="inp inp-name" type="text" id="newGroupName" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–∑–≤–∞–Ω–∏–µ)">
            <input class="inp inp-mono" type="text" id="newMainBarcode" placeholder="–ì–ª–∞–≤–Ω—ã–π –®–ö">
            <input class="inp inp-mono" type="text" id="newSynonyms" placeholder="–°–∏–Ω–æ–Ω–∏–º—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
            <div></div>
            <button id="createGroupBtn" class="btn btn-success btn-disk" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
            <button id="clearNewGroupBtn" class="btn btn-secondary btn-del" title="–°–±—Ä–æ—Å">–°–±—Ä–æ—Å</button>
          </div>
        </div>
      </div>

      <!-- Groups list -->
      <div class="rows-wrap">
        <div id="groupsContainer"></div>
      </div>

    </div><!-- /editorBody -->
  </div><!-- /section-card -->

</div><!-- /main-wrapper -->

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">üîó –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-sim-row">
        <div class="modal-sim-pct" id="modalSimilarity">0%</div>
        <div class="action-info-compact" id="actionInfoCompact" style="margin:0;flex:1;">
          <span id="actionTextCompact"></span>
        </div>
      </div>
      <table class="cmp-table" style="margin-top:4px;">
        <tr class="cmp-row1">
          <td class="cmp-col-src"><span class="cmp-src-label" id="modalLabel1">üìÑ</span></td>
          <td class="cmp-col-name"><span class="cmp-name-text" id="modalPriceName"></span></td>
          <td class="cmp-col-bc"><span class="cmp-bc-text" id="modalPriceBarcode"></span></td>
        </tr>
        <tr class="cmp-row2">
          <td class="cmp-col-src"><span class="cmp-src-label" id="modalLabel2">üè™</span></td>
          <td class="cmp-col-name"><span class="cmp-name-text" id="modalMainName"></span></td>
          <td class="cmp-col-bc"><span class="cmp-bc-text" id="modalMainBarcode"></span></td>
        </tr>
      </table>
      <div id="modalPriceNorm" style="display:none;"></div>
      <div id="modalMainNorm" style="display:none;"></div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn confirm" id="confirmBtn" onclick="confirmAction()"></button>
    </div>
  </div>
</div>

<!-- Embedded data for self-save HTML -->
<script id="embeddedData" type="application/json"></script>

<script>
// =============================================================================
// –û–ë–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –æ–±–æ–∏—Ö –±–ª–æ–∫–æ–≤
// =============================================================================
let sharedData = {};       // { barcode: [name, ...synonyms], ... }
let changesCount = 0;      // —Å—á—ë—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Smart Matcher

// Smart Matcher specific state
let allPricesFiles = []; // [{name, data}] ‚Äî –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–∞–π—Å—ã
let allMatches = [];
let matchResults = [];
let highMatches = [];
let reviewItems = [];
let addedItems = []; // –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –ø–∞—Ä—ã
let pendingAction = null;
let currentView = 'high';

// Editor specific state
let editorConflicts = new Set();
let editorSearchQuery = "";

const BARCODE_COLS = ['—à—Ç—Ä–∏—Ö–∫–æ–¥','—à—Ç—Ä–∏—Ö-–∫–æ–¥','barcode','–®–ö','—à–∫','–∫–æ–¥','ean','–®—Ç—Ä–∏—Ö–∫–æ–¥'];
const NAME_COLS = ['–Ω–∞–∑–≤–∞–Ω–∏–µ','–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä','–ø—Ä–æ–¥—É–∫—Ç','–ù–∞–∑–≤–∞–Ω–∏–µ','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ù–∞–∏–º','–Ω–∞–∏–º'];
const SYNONYM_COLS = ['—Å–∏–Ω–æ–Ω–∏–º—ã','synonyms','—Å–∏–Ω–æ–Ω–∏–º','synonym','–°–∏–Ω–æ–Ω–∏–º—ã'];

const SIMILARITY_THRESHOLD = 40;
const REVIEW_THRESHOLD = 60;  // 60‚Äì84% ‚Äî –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
const HIGH_THRESHOLD = 85;    // ‚â•85% ‚Äî –≤—ã—Å–æ–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ


// =============================================================================
// –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê / –°–û–•–†–ê–ù–ï–ù–ò–ï JSON
// =============================================================================
document.getElementById('globalJsonInput').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const fn = file.name.toLowerCase();
    if (!fn.endsWith('.json')) {
      throw new Error('–ë–∞–∑–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ JSON. –î–ª—è –ø—Ä–∞–π—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–æ–∫ Smart Matcher');
    }
    const text = await file.text();
    const parsed = JSON.parse(text);
    if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON');

    sharedData = parsed;
    changesCount = 0;

    const count = Object.keys(sharedData).length;
    setGlobalJsonStatus('ok', `‚úì ${count} –∑–∞–ø–∏—Å–µ–π –∏–∑ "${file.name}"`);
    document.getElementById('globalChangesBadge').classList.remove('show');

    onSharedDataLoaded();
  } catch (err) {
    setGlobalJsonStatus('err', `–û—à–∏–±–∫–∞: ${err.message}`);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
  }
  e.target.value = '';
});

function setGlobalJsonStatus(type, text) {
  const el = document.getElementById('globalJsonStatus');
  el.textContent = text;
  el.className = 'json-status' + (type ? ' ' + type : '');
}

function onSharedDataLoaded() {
  const keys = Object.keys(sharedData);
  const groupCount = keys.length;
  let synCount = 0;
  for (const k of keys) {
    const arr = sharedData[k];
    if (Array.isArray(arr)) synCount += Math.max(0, arr.length - 1);
  }
  const statusEl = document.getElementById('matcherJsonStatus');
  statusEl.textContent = `‚úì ${groupCount} –≥—Ä—É–ø–ø, ${synCount} —Å–∏–Ω–æ–Ω–∏–º–æ–≤`;
  statusEl.style.color = '#34c759';
  document.getElementById('jsonStatusBox').classList.add('loaded');

  editorRefreshDerivedState();
  if (allPricesFiles.length > 0) performEnhancedMatching();
  editorRefreshDerivedState();
}

async function saveSharedData() {
  const json = JSON.stringify(sharedData, null, 2);
  const now = new Date();
  const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  const fileName = `synonyms_${ts}.json`;
  const blob = new Blob([json], { type: 'application/json' });

  if (window.showSaveFilePicker) {
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description: 'JSON —Ñ–∞–π–ª', accept: { 'application/json': ['.json'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      const count = Object.keys(sharedData).length;
      setGlobalJsonStatus('ok', `‚úì JSON —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${count} –∑–∞–ø–∏—Å–µ–π`);
      changesCount = 0;
      document.getElementById('globalChangesBadge').classList.remove('show');
      return;
    } catch (err) {
      if (err.name === 'AbortError') return;
      // fallback to legacy download
    }
  }
  // Legacy fallback
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

async function saveAsHtml() {
  // –í–ø–∏—Å—ã–≤–∞–µ–º sharedData –≤ <script id="embeddedData">
  const el = document.getElementById('embeddedData');
  if (!el) { alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ embeddedData'); return; }

  // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ —Å–∫—Ä–∏–ø—Ç–∞ –≤–Ω—É—Ç—Ä–∏ JSON —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –ø–∞—Ä—Å–µ—Ä
  const closeTag = '</' + 'script';
  const json = JSON.stringify(sharedData, null, 2).replace(new RegExp(closeTag, 'gi'), '<\\/script');
  el.textContent = json;

  // –°–Ω–∏–º–∞–µ–º disabled —Å –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á—Ç–æ–±—ã –æ–Ω –ø–æ–ø–∞–ª –≤ –∞—É—Ç–ø—É—Ç –∞–∫—Ç–∏–≤–Ω—ã–º
  const saveBtn = document.getElementById('globalSaveBtn');
  const wasDis = saveBtn.disabled;
  saveBtn.disabled = false;

  const htmlStr = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
  saveBtn.disabled = wasDis;

  const now = new Date();
  const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  const fileName = `synonyms_app_${ts}.html`;
  const blob = new Blob([htmlStr], { type: 'text/html;charset=utf-8' });

  if (window.showSaveFilePicker) {
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description: 'HTML –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', accept: { 'text/html': ['.html'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      setGlobalJsonStatus('ok', `‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${fileName}`);
      return;
    } catch (err) {
      if (err.name === 'AbortError') return;
    }
  }
  // Legacy fallback
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
  setGlobalJsonStatus('ok', `‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${fileName}`);
}

function notifyChange() {
  changesCount++;
  const badge = document.getElementById('globalChangesBadge');
  badge.textContent = `+${changesCount} –∏–∑–º.`;
  badge.classList.add('show');
}

// =============================================================================
// –°–í–û–†–ê–ß–ò–í–ê–ï–ú–´–ï –°–ï–ö–¶–ò–ò
// =============================================================================
function toggleSection(id) {
  const body = document.getElementById(id + 'Body');
  const toggle = document.getElementById(id + 'Toggle');
  const header = document.getElementById(id + 'Header');
  const isHidden = body.classList.contains('hidden');
  body.classList.toggle('hidden', !isHidden);
  toggle.classList.toggle('rotated', isHidden);
  header.classList.toggle('collapsed', !isHidden);
}

// =============================================================================
// –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –î–í–ò–ñ–û–ö –ú–ê–¢–ß–ò–ù–ì–ê V4
// =============================================================================

// ‚îÄ‚îÄ –§–û–ù–ï–¢–ò–ß–ï–°–ö–ê–Ø –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø Latin ‚Üí Cyrillic ‚îÄ‚îÄ
// –ü—Ä–∏–Ω—Ü–∏–ø—ã:
//   1. –ú–Ω–æ–≥–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ä–∞–Ω—å—à–µ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω)
//   2. –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: 'u' –º–µ–∂–¥—É —Å–æ–≥–ª–∞—Å–Ω—ã–º–∏ ‚Üí '–∞' (bubble‚Üí–±–∞–±–±–ª—Å)
//   3. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–ª–æ–≤: -bles/-les/-es/-e (silent)
//   4. c/g –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–ª–µ–¥—É—é—â–µ–π –±—É–∫–≤—ã (–ø–µ—Ä–µ–¥ e/i ‚Üí –º—è–≥–∫–∏–µ)
//
// –ü—Ä–∏–º–µ—Ä—ã: halls‚Üí—Ö–æ–ª—Å, bubbles‚Üí–±–∞–±–±–ª—Å, speed‚Üí—Å–ø–∏–¥, night‚Üí–Ω–∞–π—Ç, action‚Üí—ç–∫—à–Ω

// –°–ª–æ–≤–æ-–∫–æ–Ω–µ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ü–û–°–õ–ï _translitWord (—Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
const _WE = [
  [/–±–ª–µ—Å$/, '–±–ª—Å'],    // bubbles‚Üí–±–∞–±–±–ª—Å, troubles‚Üí—Ç—Ä–∞–±–±–ª—Å
  [/—Ç–ª–µ—Å$/, '—Ç–ª—Å'],    // bottles‚Üí–±–æ—Ç–ª—Å, rattles‚Üí—Ä–∞—Ç—Ç–ª—Å
  [/–ø–ª–µ—Å$/, '–ø–ª—Å'],    // apples‚Üí—ç–ø–ø–ª—Å
  [/–ª–µ—Å$/, '–ª—Å'],      // –ª—é–±—ã–µ -les –≤ –∫–æ–Ω—Ü–µ
  [/([–±–≤–≥–¥–∂–∑–∫–ª–º–Ω–ø—Ä—Å—Ç—Ñ—Ö—Ü—á—à—â])–µ—Å$/, '$1—Å'],  // consonant+es ‚Üí consonant+—Å (loves‚Üí–ª–∞–≤—Å)
  [/([–±–≤–≥–¥–∂–∑–∫–ª–º–Ω–ø—Ä—Å—Ç—Ñ—Ö—Ü—á—à—â])–µ$/, '$1'],    // –Ω–µ–º–∞—è -e –≤ –∫–æ–Ω—Ü–µ (snake‚Üí—Å–Ω—ç–π–∫)
];

const _PP = [
  // 4 —Å–∏–º–≤–æ–ª–∞
  ['ight', '–∞–π—Ç'],   // night, light, right
  ['tion', '—à–Ω'],    // action‚Üí–∞–∫—à–Ω, nation‚Üí–Ω–µ–π—à–Ω
  ['ough', '–æ—Ñ'],    // tough, rough, enough
  // 3 —Å–∏–º–≤–æ–ª–∞
  ['sch',  '—à'],     // Bosch‚Üí–±–æ—à, Schulz‚Üí—à—É–ª—å–∑ (–Ω–µ–º–µ—Ü–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π sch = —à, –Ω–µ —â)
  ['tch',  '—á'],     // watch, catch, match
  ['all',  '–æ–ª'],    // halls‚Üí—Ö–æ–ª—Å, ball‚Üí–±–æ–ª, fall‚Üí—Ñ–æ–ª
  ['ing',  '–∏–Ω–≥'],   // spring‚Üí—Å–ø—Ä–∏–Ω–≥, ring‚Üí—Ä–∏–Ω–≥
  ['igh',  '–∞–π'],    // high‚Üí—Ö–∞–π, sigh‚Üí—Å–∞–π
  ['ull',  '—É–ª'],    // pull, bull, full
  ['arr',  '–∞—Ä'],    // arrow, barrel
  ['oor',  '—É—Ä'],    // floor, door
  ['alk',  '–æ–∫'],    // walk‚Üí–≤–æ–∫, talk‚Üí—Ç–æ–∫
  ['awn',  '–æ–Ω'],    // dawn‚Üí–¥–æ–Ω, lawn‚Üí–ª–æ–Ω
  // 2 —Å–∏–º–≤–æ–ª–∞ ‚Äî –¥–∏–≥—Ä–∞—Ñ—ã —Å–æ–≥–ª–∞—Å–Ω—ã—Ö
  ['sh',   '—à'],     // shell‚Üí—à–µ–ª–ª, show‚Üí—à–æ—É
  ['ch',   '—á'],     // champion‚Üí—á–µ–º–ø–∏–æ–Ω, check‚Üí—á–µ–∫
  ['zh',   '–∂'],
  ['kh',   '—Ö'],
  ['ph',   '—Ñ'],     // phone‚Üí—Ñ–æ–Ω, photo‚Üí—Ñ–æ—Ç–æ
  ['th',   '—Ç'],     // thermos‚Üí—Ç–µ—Ä–º–æ—Å, thunder‚Üí—Ç–∞–Ω–¥–µ—Ä
  ['wh',   '–≤'],     // white‚Üí–≤–∞–π—Ç, wheel‚Üí–≤–∏–ª
  ['ck',   '–∫'],     // black‚Üí–±–ª—ç–∫, rock‚Üí—Ä–æ–∫
  ['qu',   '–∫–≤'],    // quick‚Üí–∫–≤–∏–∫, queen‚Üí–∫–≤–∏–Ω
  ['ts',   '—Ü'],
  ['tz',   '—Ü'],
  // 2 —Å–∏–º–≤–æ–ª–∞ ‚Äî –≥–ª–∞—Å–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è
  ['oo',   '—É'],     // cool‚Üí–∫—É–ª, boost‚Üí–±—É—Å—Ç, moon‚Üí–º—É–Ω
  ['ee',   '–∏'],     // speed‚Üí—Å–ø–∏–¥, sweet‚Üí—Å–≤–∏—Ç, beer‚Üí–±–∏—Ä
  ['ea',   '–∏'],     // cream‚Üí–∫—Ä–∏–º, clean‚Üí–∫–ª–∏–Ω, tea‚Üí—Ç–∏
  ['ui',   '—É'],     // juice‚Üí–¥–∂—É—Å, fruit‚Üí—Ñ—Ä—É—Ç, suit‚Üí—Å—É—Ç
  ['ew',   '—é'],     // new‚Üí–Ω—é, brew‚Üí–±—Ä—é, few‚Üí—Ñ—é
  ['aw',   '–æ'],     // law‚Üí–ª–æ, draw‚Üí–¥—Ä–æ, saw‚Üí—Å–æ
  ['ow',   '–æ—É'],    // show‚Üí—à–æ—É, know‚Üí–Ω–æ—É, low‚Üí–ª–æ—É
  ['oi',   '–æ–π'],    // oil‚Üí–æ–π–ª, coin‚Üí–∫–æ–π–Ω
  ['oy',   '–æ–π'],    // boy‚Üí–±–æ–π, toy‚Üí—Ç–æ–π
  ['ai',   '–µ–π'],    // rain‚Üí—Ä–µ–π–Ω, paint‚Üí–ø–µ–π–Ω—Ç
  ['ay',   '–µ–π'],    // day‚Üí–¥–µ–π, play‚Üí–ø–ª–µ–π
  ['au',   '–æ'],     // auto‚Üí–æ—Ç–æ, pause‚Üí–ø–æ–∑
  ['ou',   '—É'],     // group‚Üí–≥—Ä—É–ø, soup‚Üí—Å—É–ø
  // 2 —Å–∏–º–≤–æ–ª–∞ ‚Äî —É–¥–≤–æ–µ–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–Ω—ã–µ (—Å–µ—Ä–µ–¥–∏–Ω–∞ —Å–ª–æ–≤–∞)
  ['bb',   '–±–±'],    // bubble‚Üí–±–∞–±–±–ª, rubber‚Üí—Ä–∞–±–±–µ—Ä
  ['tt',   '—Ç—Ç'],    // button‚Üí–±–∞—Ç—Ç–æ–Ω, bottle‚Üí–±–æ—Ç—Ç–ª
  ['ll',   '–ª–ª'],    // hello‚Üí—Ö—ç–ª–ª–æ—É, bell‚Üí–±–µ–ª–ª
  ['ss',   '—Å—Å'],    // class‚Üí–∫–ª–∞—Å—Å, bass‚Üí–±–∞—Å—Å
  ['rr',   '—Ä—Ä'],    // arrow‚Üí–∞—Ä—Ä–æ—É, mirror‚Üí–º–∏—Ä—Ä–æ—Ä
  ['nn',   '–Ω–Ω'],    // inn‚Üí–∏–Ω–Ω, connect‚Üí–∫–æ–Ω–Ω–µ–∫—Ç
  ['pp',   '–ø–ø'],    // apple‚Üí—ç–ø–ø–ª, happy‚Üí—Ö—ç–ø–ø–∏
  ['ff',   '—Ñ—Ñ'],    // off‚Üí–æ—Ñ—Ñ, effect‚Üí—ç—Ñ—Ñ–µ–∫—Ç
  ['gg',   '–≥–≥'],    // egg‚Üí—ç–≥–≥, bigger‚Üí–±–∏–≥–≥–µ—Ä
  ['mm',   '–º–º'],    // hammer‚Üí—Ö–∞–º–º–µ—Ä, comm‚Üí–∫–æ–º–º
  ['dd',   '–¥–¥'],    // add‚Üí–∞–¥–¥, middle‚Üí–º–∏–¥–ª
  ['cc',   '–∫–∫'],    // account‚Üí–∞–∫–∫–∞—É–Ω—Ç
];

// –û–¥–∏–Ω–æ—á–Ω—ã–µ –±—É–∫–≤—ã ‚Äî –±–µ–∑ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª (–∑–∞–ø–∞—Å–Ω—ã–µ)
const _SC = {
  a:'–∞', b:'–±', d:'–¥', e:'–µ', f:'—Ñ', h:'—Ö', i:'–∏', k:'–∫', l:'–ª',
  m:'–º', n:'–Ω', o:'–æ', p:'–ø', q:'–∫', r:'—Ä', s:'—Å', t:'—Ç', v:'–≤',
  w:'–≤', z:'–∑',
};

// –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–æ–≥–ª–∞—Å–Ω—ã–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞ 'u'
const _ENG_CONS = new Set([...'bcdfghjklmnpqrstvwxz']);

function _translitWord(word) {
  // word: —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã
  const len = word.length;
  let out = '';
  let i = 0;

  while (i < len) {
    let matched = false;

    // –ü—Ä–æ–±—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É (–¥–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –≤ –º–∞—Å—Å–∏–≤–µ)
    for (const [pat, cyr] of _PP) {
      if (word.startsWith(pat, i)) {
        out += cyr;
        i += pat.length;
        matched = true;
        break;
      }
    }
    if (matched) continue;

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±—É–∫–≤
    const ch = word[i];
    const prev = i > 0 ? word[i-1] : '';
    const next = i < len-1 ? word[i+1] : '';
    const next2 = i < len-2 ? word[i+2] : '';

    if (ch === 'c') {
      // c –ø–µ—Ä–µ–¥ e/i/y ‚Üí —Å, –∏–Ω–∞—á–µ ‚Üí –∫
      out += 'eiy'.includes(next) ? '—Å' : '–∫';
    } else if (ch === 'g') {
      // g –ø–µ—Ä–µ–¥ e/i/y ‚Üí –¥–∂ (gel, giant), –∏–Ω–∞—á–µ ‚Üí –≥
      out += 'eiy'.includes(next) ? '–¥–∂' : '–≥';
    } else if (ch === 'j') {
      out += '–¥–∂';  // juice‚Üí–¥–∂—É—Å, jar‚Üí–¥–∂–∞—Ä
    } else if (ch === 'u') {
      // u –º–µ–∂–¥—É –¥–≤—É–º—è —Å–æ–≥–ª–∞—Å–Ω—ã–º–∏ ‚Üí '–∞' (bubble‚Üí–±–∞–±–±–ª, truck‚Üí—Ç—Ä–∞–∫, fun‚Üí—Ñ–∞–Ω)
      // u –≤ –Ω–∞—á–∞–ª–µ —Å–ª–æ–≤–∞ –∏–ª–∏ –ø–µ—Ä–µ–¥ –≥–ª–∞—Å–Ω–æ–π ‚Üí '—É'
      const prevC = _ENG_CONS.has(prev);
      const nextC = _ENG_CONS.has(next);
      out += (prev && prevC && next && nextC) ? '–∞' : '—É';
    } else if (ch === 'y') {
      // y –≤ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –∫–æ–Ω—Ü–µ —Å–ª–æ–≤–∞ ‚Üí –π; –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –º–µ–∂–¥—É —Å–æ–≥–ª ‚Üí –∏
      if (!prev || !next) out += '–π';
      else out += '–∏';
    } else if (ch === 'x') {
      // x –≤ –Ω–∞—á–∞–ª–µ —Å–ª–æ–≤–∞ ‚Üí –∑ (xylophone), –∏–Ω–∞—á–µ ‚Üí –∫—Å
      out += (i === 0) ? '–∑' : '–∫—Å';
    } else if (ch === 'e' && i === len-1) {
      // –Ω–µ–º–∞—è e –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ —Å–ª–æ–≤–∞ ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
      // (snake, name, store ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–∞—è e –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è)
    } else {
      out += _SC[ch] || ch;
    }
    i++;
  }
  return out;
}

function latinToCyrillic(s) {
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –ª–∞—Ç–∏–Ω—Å–∫–æ–µ —Å–ª–æ–≤–æ –æ—Ç–¥–µ–ª—å–Ω–æ
  // –ù–µ–ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã (–ø—Ä–æ–±–µ–ª—ã, —Ü–∏—Ñ—Ä—ã, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
  return s.replace(/[a-z]+/g, word => {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–ª–æ–≤–æ-–∫–æ–Ω–µ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞ —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º
    // –ù–ï–¢ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–ª–æ–≤–µ, –ø–æ—Ç–æ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ—Ä—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    const raw = _translitWord(word);
    // –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞: —É–±–∏—Ä–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–ª–æ–≤–æ-–∫–æ–Ω–µ—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ
    let r = raw;
    for (const [re, rep] of _WE) r = r.replace(re, rep);
    return r;
  });
}

// ‚îÄ‚îÄ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ï–î–ò–ù–ò–¶ ‚îÄ‚îÄ
// –í—Å—ë –∫ –±–∞–∑–æ–≤—ã–º –µ–¥–∏–Ω–∏—Ü–∞–º: –≥, –º–ª, –º–º.
// –í–∞–∂–Ω–æ: –ø—Ä–∏–º–µ–Ω—è–µ–º –ü–û–°–õ–ï —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ "kg"‚Üí"–∫–≥", "ml"‚Üí"–º–ª" —É–∂–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞.
// –ú–æ—ë —É–ª—É—á—à–µ–Ω–∏–µ: —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ "4x40", "4√ó40", "4—Ö40" ‚Üí –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–∏—Å–ª–∞.
// –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π, –∫—Ä–µ–ø–µ–∂–∞, —Ç–µ–∫—Å—Ç–∏–ª—è.
const _UNITS = [
  // –º–∞—Å—Å–∞ ‚Üí –≥
  [/(\d+(?:[.,]\d+)?)\s*(?:—Ç–æ–Ω–Ω|—Ç–Ω)\b/g,                   1e6,   '–≥'],
  [/(\d+(?:[.,]\d+)?)\s*–∫–≥\b/g,                             1000,  '–≥'],
  [/(\d+(?:[.,]\d+)?)\s*–º–≥\b/g,                             0.001, '–≥'],
  [/(\d+(?:[.,]\d+)?)\s*(?:–≥—Ä?)\b/g,                        1,     '–≥'],
  [/(\d+(?:[.,]\d+)?)\s*–≥(?=[^–∞-—è—ë]|$)/g,                   1,     '–≥'],
  // –æ–±—ä—ë–º ‚Üí –º–ª
  [/(\d+(?:[.,]\d+)?)\s*(?:–ª–∏—Ç—Ä|–ª–∏—Ç)\b/g,                   1000,  '–º–ª'],
  [/(\d+(?:[.,]\d+)?)\s*–ª\b/g,                               1000,  '–º–ª'],
  [/(\d+(?:[.,]\d+)?)\s*–º–ª\b/g,                              1,     '–º–ª'],
  // –¥–ª–∏–Ω–∞ ‚Üí –º–º
  [/(\d+(?:[.,]\d+)?)\s*(?:–º–µ—Ç—Ä|–º–µ—Ç—Ä–∞)\b/g,                  1000,  '–º–º'],
  [/(\d+(?:[.,]\d+)?)\s*–º\b/g,                               1000,  '–º–º'],
  [/(\d+(?:[.,]\d+)?)\s*–¥–º\b/g,                              100,   '–º–º'],
  [/(\d+(?:[.,]\d+)?)\s*—Å–º\b/g,                              10,    '–º–º'],
  [/(\d+(?:[.,]\d+)?)\s*(?:–¥—é–π–º|")\b/g,                     25.4,  '–º–º'],
  [/(\d+(?:[.,]\d+)?)\s*–º–º\b/g,                              1,     '–º–º'],
];
function normalizeUnits(s) {
  let r = s;
  for (const [re, mult, suf] of _UNITS) {
    re.lastIndex = 0;
    r = r.replace(re, (_, n) => {
      const v = parseFloat(n.replace(',', '.')) * mult;
      const val = Math.abs(v - Math.round(v)) < 0.0001 ? Math.round(v) : +v.toFixed(3);
      return val + suf;
    });
  }
  return r;
}

// ‚îÄ‚îÄ –ì–õ–ê–í–ù–ê–Ø –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø (—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫) ‚îÄ‚îÄ
function normalizeForMatch(raw) {
  let s = String(raw || '');
  if (!s.trim()) return '';

  // 1. –ù–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
  s = s.toLowerCase();
  // 2. —ë ‚Üí –µ (–¥–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –ª–∏—à–Ω–∏–π —Ä–∞–∑)
  s = s.replace(/—ë/g, '–µ');
  // 3. Latin ‚Üí Cyrillic
  s = latinToCyrillic(s);
  // 4. –ï–¥–∏–Ω–∏—Ü—ã ‚Üí –±–∞–∑–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (–≤—Å–µ —Å–ª–æ–≤–∞ —Ç–µ–ø–µ—Ä—å –∫–∏—Ä–∏–ª–ª.)
  s = normalizeUnits(s);
  // 4b. –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ "4x40", "4√ó40", "4*40" ‚Üí "4 40"
  //     –ù–û "5w30" (–≤—è–∑–∫–æ—Å—Ç—å), "m8" (–º–µ—Ç—Ä–∏—á.—Ä–µ–∑—å–±–∞) ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å,
  //     –ø–æ—Ç–æ–º—É —á—Ç–æ "w" –∏ –±—É–∫–≤–∞ –ø–æ—Å–ª–µ —Ü–∏—Ñ—Ä—ã —É–∂–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–∞:
  //     "5w30" ‚Üí "5–≤30" ‚Üí —Ä–∞–∑–¥–µ–ª—è–µ–º —Ü–∏—Ñ—Ä—É-–±—É–∫–≤—É: "5 –≤30"? –ù–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–∏–º.
  //     –¢–æ–ª—å–∫–æ —è–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: √ó —Ö (–∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–æ–µ) x (–ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–ª) –º–µ–∂–¥—É –¥–≤—É–º—è —á–∏—Å–ª–∞–º–∏.
  s = s.replace(/(\d+)\s*[x—Ö√ó*]\s*(\d+)/g, '$1 $2');
  // 4c. –ó–∞–ø—è—Ç–∞—è –∫–∞–∫ –¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –≤–Ω—É—Ç—Ä–∏ —á–∏—Å–ª–∞: "3,2" ‚Üí "3.2"
  s = s.replace(/(\d),(\d)/g, '$1.$2');
  // 5. –í—Å—ë –∫—Ä–æ–º–µ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã, —Ü–∏—Ñ—Ä –∏ —Ç–æ—á–∫–∏-–≤-—á–∏—Å–ª–µ ‚Üí –ø—Ä–æ–±–µ–ª
  s = s.replace(/[^–∞-—è0-9.\s]/g, ' ');
  s = s.replace(/(?<!\d)\.(?!\d)/g, ' '); // —Ç–æ—á–∫–∞ –Ω–µ –º–µ–∂–¥—É —Ü–∏—Ñ—Ä–∞–º–∏ ‚Üí –ø—Ä–æ–±–µ–ª
  // 6. –£–±—Ä–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
  s = s.replace(/\s+/g, ' ').trim();
  // 7. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–æ–≤ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
  const tokens = s.split(' ').filter(Boolean);
  tokens.sort();
  return tokens.join(' ');
}

// ‚îÄ‚îÄ –¢–†–ò–ì–†–ê–ú–ú–´ –ü–û –¢–û–ö–ï–ù–ê–ú (–ø–æ —Å–ø–µ–∫–µ) ‚îÄ‚îÄ
// –ö–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî –Ω–µ—Ç ¬´—Å–∫–≤–æ–∑–Ω—ã—Ö¬ª —Ç—Ä–∏–≥—Ä–∞–º–º –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏.
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –º—É–ª—å—Ç–∏–º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ Dice –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–∞—Ö.
function buildTrigramBag(normalizedStr) {
  const bag = new Map();
  for (const token of normalizedStr.split(' ')) {
    if (!token) continue;
    if (token.length < 3) {
      // –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–æ–∫–µ–Ω—ã (1-2 —Å–∏–º–≤–æ–ª–∞) –¥–æ–±–∞–≤–ª—è–µ–º —Ü–µ–ª–∏–∫–æ–º –∫–∞–∫ ¬´–ø—Å–µ–≤–¥–æ-—Ç—Ä–∏–≥—Ä–∞–º–º—É¬ª
      bag.set(token, (bag.get(token) || 0) + 1);
      continue;
    }
    for (let i = 0; i <= token.length - 3; i++) {
      const tri = token.slice(i, i + 3);
      bag.set(tri, (bag.get(tri) || 0) + 1);
    }
  }
  return bag;
}
function trigramSim(n1, n2) {
  if (!n1 && !n2) return 1;
  if (!n1 || !n2) return 0;
  const b1 = buildTrigramBag(n1), b2 = buildTrigramBag(n2);
  let total1 = 0, total2 = 0, inter = 0;
  for (const [k, v] of b1) { total1 += v; if (b2.has(k)) inter += Math.min(v, b2.get(k)); }
  for (const [, v] of b2) total2 += v;
  if (total1 + total2 === 0) return 0;
  return (2 * inter) / (total1 + total2); // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –î–∞–π—Å–∞
}

// ‚îÄ‚îÄ –ß–ò–°–õ–ê: Dice-—Å—Ö–æ–∂–µ—Å—Ç—å –º—É–ª—å—Ç–∏–º–Ω–æ–∂–µ—Å—Ç–≤ ‚îÄ‚îÄ
function extractNums(normalizedStr) {
  // –ß–∏—Å–ª–∞ —Å —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏ –µ–¥–∏–Ω–∏—Ü —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã (500–≥, 1000–º–ª, 25–º–º).
  // –ò–∑–≤–ª–µ–∫–∞–µ–º –í–°–ï —á–∏—Å–ª–∞ –≤–∫–ª—é—á–∞—è –¥—Ä–æ–±–Ω—ã–µ.
  const nums = [];
  for (const m of (normalizedStr.match(/\d+(?:\.\d+)?/g) || [])) nums.push(parseFloat(m));
  return nums;
}
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: null = –Ω–µ—Ç —á–∏—Å–µ–ª —É –æ–±–æ–∏—Ö (–º–µ—Ç—Ä–∏–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç),
//             'oneside' = —á–∏—Å–ª–∞ —Ç–æ–ª—å–∫–æ —É –æ–¥–Ω–æ–≥–æ (—à—Ç—Ä–∞—Ñ),
//             0..1 = Dice –ø–æ —á–∏—Å–ª–∞–º
function numResult(nums1, nums2) {
  const n1 = nums1.length, n2 = nums2.length;
  if (n1 === 0 && n2 === 0) return null;          // –Ω–µ—Ç —á–∏—Å–µ–ª ‚Üí –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç
  if (n1 === 0 || n2 === 0) return 'oneside';     // —Ç–æ–ª—å–∫–æ —É –æ–¥–Ω–æ–≥–æ ‚Üí —à—Ç—Ä–∞—Ñ
  // Dice –ø–æ –º—É–ª—å—Ç–∏–º–Ω–æ–∂–µ—Å—Ç–≤–∞–º
  const bag1 = new Map(), bag2 = new Map();
  for (const n of nums1) { const k = String(n); bag1.set(k, (bag1.get(k)||0)+1); }
  for (const n of nums2) { const k = String(n); bag2.set(k, (bag2.get(k)||0)+1); }
  let inter = 0;
  for (const [k, v] of bag1) if (bag2.has(k)) inter += Math.min(v, bag2.get(k));
  return (2 * inter) / (n1 + n2);
}

// ‚îÄ‚îÄ LCS: –Ω–∞–∏–¥–ª–∏–Ω–Ω–µ–π—à–∞—è –æ–±—â–∞—è –ü–û–î–ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ (–ø–æ —Å–ø–µ–∫–µ) ‚îÄ‚îÄ
// –ù–µ substring! LCS –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–∏–º–≤–æ–ª—ã.
// "–Ω–≥–∫ –±–ø6–µ—Å" –∏ "–Ω–≥–∫ bp6es" ‚Üí –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã ‚Üí LCS = 100%.
// –ò—Å–ø–æ–ª—å–∑—É–µ–º rolling-array DP, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 120 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏.
function lcsLen(a, b) {
  const A = a.slice(0, 120), B = b.slice(0, 120);
  let prev = new Uint8Array(B.length + 1), curr = new Uint8Array(B.length + 1);
  for (let i = 0; i < A.length; i++) {
    for (let j = 0; j < B.length; j++) {
      curr[j+1] = A[i] === B[j] ? prev[j] + 1 : Math.max(curr[j], prev[j+1]);
    }
    [prev, curr] = [curr, prev]; curr.fill(0);
  }
  return prev[B.length];
}
function lcsSim(n1, n2) {
  if (!n1 && !n2) return 1;
  if (!n1 || !n2) return 0;
  return (2 * lcsLen(n1, n2)) / (Math.min(n1.length,120) + Math.min(n2.length,120));
}

// ‚îÄ‚îÄ –ë–´–°–¢–†–´–ô –ü–†–ï–î–§–ò–õ–¨–¢–†: –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ —Ç–æ–∫–µ–Ω–∞–º ‚îÄ‚îÄ
// –í–º–µ—Å—Ç–æ MinHash LSH (–Ω–µ—Ç datasketch –≤ –±—Ä–∞—É–∑–µ—Ä–µ).
// O(N) –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ, O(1) —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.
// –î–ª—è 2000 –ø–æ–∑–∏—Ü–∏–π √ó 2000 –ø–æ–∑–∏—Ü–∏–π: 4–º–ª–Ω —Å—Ä–∞–≤–Ω–µ–Ω–∏–π ‚Üí —Å –ø—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–æ–º ~40 —Å—Ä–∞–≤–Ω–µ–Ω–∏–π –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç.
function buildInvIndex(items) {
  const idx = new Map();
  items.forEach((item, i) => {
    for (const tok of item._norm.split(' ')) {
      if (tok.length < 2) continue;
      if (!idx.has(tok)) idx.set(tok, []);
      idx.get(tok).push(i);
    }
  });
  return idx;
}
function getCandidates(norm, idx, items, topN = 25) {
  const toks = norm.split(' ').filter(t => t.length >= 2);
  const freq = new Map();
  for (const tok of toks) {
    for (const id of (idx.get(tok) || [])) freq.set(id, (freq.get(id)||0) + 1);
  }
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
  const ranked = [...freq.entries()].sort((a,b) => b[1]-a[1]).slice(0, topN).map(([id])=>id);
  // –ï—Å–ª–∏ –º–∞–ª–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –ø–µ—Ä–≤–æ–º—É —Ç–æ–∫–µ–Ω—É (fallback)
  if (ranked.length < 5 && toks.length > 0) {
    const first = toks[0];
    items.forEach((item, id) => {
      if (!freq.has(id) && item._norm.includes(first)) ranked.push(id);
    });
  }
  return ranked.slice(0, topN);
}

// ‚îÄ‚îÄ –ò–¢–û–ì–û–í–´–ô –†–ê–°–ß–Å–¢ –°–•–û–ñ–ï–°–¢–ò ‚îÄ‚îÄ
// –°—á–∏—Ç–∞–µ—Ç –ø–æ –≤—Å–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (—Å —Ä–µ–±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º –∏ –±–µ–∑),
// –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
function _calcOneVariant(n1, n2) {
  if (n1 === n2 && n1.length > 0) {
    return { score: 100, tri: 1, numR: 1, lcs: 1 };
  }
  const tri = trigramSim(n1, n2);
  const nums1 = extractNums(n1), nums2 = extractNums(n2);
  const numR  = numResult(nums1, nums2);
  const lcs   = lcsSim(n1, n2);
  let composite;
  if (numR === null)      composite = tri * 0.8 + lcs * 0.2;
  else if (numR === 'oneside') composite = Math.max(0, tri * 0.5 + lcs * 0.2 - 0.3);
  else                    composite = tri * 0.5 + numR * 0.3 + lcs * 0.2;
  return { score: Math.round(Math.min(100, Math.max(0, composite * 100))), tri, numR, lcs };
}

function calculateSimilarity(text1, text2) {
  const vars1 = normalizeVariants(text1);
  const vars2 = normalizeVariants(text2);

  let best = null, bestN1 = vars1[0], bestN2 = vars2[0];
  for (const v1 of vars1) {
    for (const v2 of vars2) {
      const r = _calcOneVariant(v1, v2);
      if (!best || r.score > best.score) { best = r; bestN1 = v1; bestN2 = v2; }
    }
  }

  const { score, tri, numR, lcs } = best;
  const isRebranded = (bestN1 !== vars1[0] || bestN2 !== vars2[0]);

  const numScore   = numR === null ? 0 : numR === 'oneside' ? -30 : Math.round(numR * 30);
  const numMatched = typeof numR === 'number' && numR > 0;
  const numPenalty = numR === 'oneside' || (typeof numR === 'number' && numR === 0);

  const tags = [];
  if (score === 100) tags.push('‚úì –¢–æ—á–Ω–æ–µ');
  if (isRebranded)   tags.push('üîÑ –†–µ–±—Ä–µ–Ω–¥–∏–Ω–≥');
  if (tri >= 0.85)   tags.push('üìä –¢—Ä–∏ ‚úì');
  if (numR === null)              tags.push('üî¢ ‚Äî');
  else if (numR === 'oneside')    tags.push('‚ö†Ô∏è –ß–∏—Å–ª–∞ —É –æ–¥–Ω–æ–≥–æ');
  else if (typeof numR === 'number' && numR > 0 && numR < 0.5) tags.push('‚ö†Ô∏è –†–∞–∑–Ω—ã–µ —á–∏—Å–ª–∞');
  else if (numMatched)            tags.push('üî¢ ‚úì');
  if (lcs >= 0.65) tags.push('üîó LCS ‚úì');

  const details = [
    { component:'üìä –¢—Ä–∏–≥—Ä–∞–º–º—ã', score: Math.round(tri * 50),  matched: tri > 0.3 },
    { component:'üî¢ –ß–∏—Å–ª–∞',     score: numScore,               matched: numMatched, penalty: numPenalty,
      note: numR === null ? '(–Ω–µ—Ç —á–∏—Å–µ–ª ‚Üí –≤–µ—Å tri)' : undefined },
    { component:'üîó LCS',       score: Math.round(lcs * 20),  matched: lcs > 0.4 },
  ];
  if (isRebranded) details.push({ component:'üîÑ –†–µ–±—Ä–µ–Ω–¥–∏–Ω–≥', score: 0, matched: true });

  const matchedTokens = new Set();
  const tok2 = new Set(bestN2.split(' '));
  for (const t of bestN1.split(' ')) if (tok2.has(t) && t.length > 1) matchedTokens.add(t);

  return { score, rawScore: score, details, tags, matchedTokens, weightPenalty: false,
           _n1: bestN1, _n2: bestN2, _orig_n1: vars1[0], _orig_n2: vars2[0] };
}

// –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
function normalizeText(text) { return normalizeForMatch(text); }
function getSignificantTokens(text) { return normalizeForMatch(text).split(' ').filter(w=>w.length>1); }
function extractNumbers(text) { return extractNums(normalizeForMatch(text)); }

// =============================================================================
// –¢–ê–ë–õ–ò–¶–ê –†–ï–ë–†–ï–ù–î–ò–ù–ì–û–í –ò –≠–ö–í–ò–í–ê–õ–ï–ù–¢–û–í
// –•—Ä–∞–Ω–∏—Ç –ø–∞—Ä—ã [—Å—Ç–∞—Ä–æ–µ/–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ ‚Üí –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ] –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.
// –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï normalizeForMatch, –ø–æ—ç—Ç–æ–º—É –≤—Å—ë —É–∂–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ + –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä.
// –î–æ–±–∞–≤–ª—è–π—Ç–µ –ª—é–±—ã–µ –Ω–æ–≤—ã–µ –ø–∞—Ä—ã ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
// =============================================================================
const REBRAND_TABLE = [
  // –ï–¥–∞ / –Ω–∞–ø–∏—Ç–∫–∏
  ['—Ö—Ä—É—Ç–∫–∞',         '–Ω–µ—Å–∫–≤–∏–∫'],
  ['—á–∏–ø—Å—ã –ª–µ–π—Å',     '–ª–∞–π—Å'],   ['–∑–∞—Ö—Ä—É—Å—Ç–∏–º',     '–ª–∞–π—Å'],
  ['–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∏–Ω–æ',  '–¥–∞–Ω–æ–Ω'],
  ['—é–Ω–∏–º–∏–ª–∫',        '–¥–∞–Ω–æ–Ω'],
  ['–ø–µ–ø—Å–∏ –∫–æ–ª–∞',     '–ø–µ–ø—Å–∏'],
  ['–∫–æ–∫–∞ –∫–æ–ª–∞',      '–∫–æ–∫–∞'],   ['–∫–æ–∫–∞-–∫–æ–ª–∞',     '–∫–æ–∫–∞'],
  ['sprite',         '—Å–ø—Ä–∞–π—Ç'], // —É–∂–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ç, –Ω–æ –Ω–∞ —Å–ª—É—á–∞–π –æ—Å—Ç–∞—Ç–∫–æ–≤
  // –ê–≤—Ç–æ / –º–∞—Å–ª–∞
  ['—à–µ–ª–ª —Ö–µ–ª–∏–∫—Å',    '—Ö–µ–ª–∏–∫—Å'],
  ['–º–æ–±–∏–ª 1',        '–º–æ–±–∏–ª'],
  ['–∫–∞—Å—Ç—Ä–æ–ª —ç–¥–∂',    '–∫–∞—Å—Ç—Ä–æ–ª'],
  ['–±–æ—à',            '–±–æ—à'],    // bosch —É–∂–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ç
  // –¢–µ—Ö–Ω–∏–∫–∞
  ['—Å–∞–º—Å—É–Ω–≥',        '—Å–∞–º—Å—É–Ω–≥'], ['—Å–∞–º—Å—Éng',       '—Å–∞–º—Å—É–Ω–≥'],
  ['—ç–ø–ª',            '—ç–ø–ø–ª'],
  // –û–¥–µ–∂–¥–∞ / —Ä–∞–∑–º–µ—Ä—ã
  ['—Ä.',             '—Ä'],      ['—Ä–∞–∑–º–µ—Ä',         '—Ä'],
  ['—Ä–∞–∑–º',           '—Ä'],
  // –û–±—â–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
  ['—à—Ç.',            '—à—Ç'],     ['—à—Ç—É–∫',           '—à—Ç'],
  ['—É–ø.',            '—É–ø'],     ['—É–ø–∞–∫–æ–≤–∫–∞',       '—É–ø'],
  ['–∫–æ—Ä.',           '–∫–æ—Ä'],    ['–∫–æ—Ä–æ–±–∫–∞',        '–∫–æ—Ä'],
  ['—Ç–∞–±.',           '—Ç–∞–±'],    ['—Ç–∞–±–ª–µ—Ç–∫–∞',       '—Ç–∞–±'],  ['—Ç–∞–±–ª–µ—Ç–∫–∏','—Ç–∞–±'],
  ['–∫–∞–ø.',           '–∫–∞–ø'],    ['–∫–∞–ø—Å—É–ª–∞',        '–∫–∞–ø'],  ['–∫–∞–ø—Å—É–ª—ã', '–∫–∞–ø'],
  ['–∞–º–ø.',           '–∞–º–ø'],    ['–∞–º–ø—É–ª–∞',         '–∞–º–ø'],  ['–∞–º–ø—É–ª—ã',  '–∞–º–ø'],
  ['—Ñ–ª.',            '—Ñ–ª'],     ['—Ñ–ª–∞–∫–æ–Ω',         '—Ñ–ª'],
  ['–ø–∞–∫.',           '–ø–∞–∫'],    ['–ø–∞–∫–µ—Ç',          '–ø–∞–∫'],  ['–ø–∞–∫–µ—Ç–∏–∫', '–ø–∞–∫'],
  ['n',              '–Ω'],      ['no',             '–Ω'],    ['nr',      '–Ω'],
  // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π
  ['–æ—Ü–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π',   '–æ—Ü–∏–Ω–∫'],  ['–æ—Ü–∏–Ω–∫.',         '–æ—Ü–∏–Ω–∫'],
  ['–Ω–µ—Ä–∂–∞–≤–µ—é—â–∏–π',    '–Ω–µ—Ä–∂'],   ['–Ω–µ—Ä–∂.',          '–Ω–µ—Ä–∂'],
  ['–≥–∞–ª—å–≤–∞–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π','–æ—Ü–∏–Ω–∫'],
];

// –°—Ç—Ä–æ–∏–º –±—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–µ–∫—Å: –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –¥–ª–∏–Ω—ã (–¥–ª–∏–Ω–Ω—ã–µ –∑–∞–º–µ–Ω—ã –ø–µ—Ä–≤—ã–º–∏)
const _REBRAND_SORTED = [...REBRAND_TABLE].sort((a,b) => b[0].length - a[0].length);

function applyRebrands(normalizedStr) {
  let s = normalizedStr;
  for (const [from, to] of _REBRAND_SORTED) {
    // –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–ª–∏ –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü —Ç–æ–∫–µ–Ω–∞
    const escaped = from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    s = s.replace(new RegExp(`(?<![–∞-—è0-9])${escaped}(?![–∞-—è0-9])`, 'g'), to);
  }
  // –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω
  return s.replace(/\s+/g, ' ').trim();
}

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ä–µ–±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ú–ê–°–°–ò–í –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: [–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π, —Å_—Ä–µ–±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º]
// –ú–∞—Ç—á–∏–Ω–≥ –±–µ—Ä—ë—Ç –ª—É—á—à–∏–π —Å–∫–æ—Ä —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –ø–∞—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
function normalizeVariants(raw) {
  const base = normalizeForMatch(raw);
  const rebranded = applyRebrands(base);
  // –ï—Å–ª–∏ —Ä–µ–±—Ä–µ–Ω–¥–∏–Ω–≥ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç
  if (rebranded === base) return [base];
  // –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω
  const rebrandedSorted = rebranded.split(' ').filter(Boolean).sort().join(' ');
  return [base, rebrandedSorted].filter((v,i,a)=>a.indexOf(v)===i);
}
// =============================================================================
// –ó–ê–ì–†–£–ó–ö–ê –ü–†–ê–ô–°–û–í (–º—É–ª—å—Ç–∏-—Ñ–∞–π–ª)
// =============================================================================
document.getElementById('multiPriceInput').addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  showProgress('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤...');
  for (const file of files) {
    try {
      let rows;
      if (file.name.toLowerCase().endsWith('.csv')) rows = await parseCSV(file);
      else rows = await parseExcel(file);
      const idx = allPricesFiles.findIndex(f => f.name === file.name);
      if (idx >= 0) allPricesFiles[idx] = { name: file.name, data: rows };
      else allPricesFiles.push({ name: file.name, data: rows });
    } catch (err) {
      alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ "${file.name}": ` + err.message);
    }
  }
  hideProgress();
  renderPriceFilesList();
  const total = allPricesFiles.reduce((s, f) => s + f.data.length, 0);
  document.getElementById('multiPriceBox').classList.add('loaded');
  document.getElementById('multiPriceStatus').textContent = `‚úì ${allPricesFiles.length} —Ñ–∞–π–ª(–æ–≤) ¬∑ ${total} –ø–æ–∑–∏—Ü–∏–π`;
  if (allPricesFiles.length >= 1) performEnhancedMatching();
  e.target.value = '';
});

function renderPriceFilesList() {
  const container = document.getElementById('priceFilesList');
  if (!allPricesFiles.length) { container.style.display = 'none'; return; }
  container.style.display = '';
  container.innerHTML = allPricesFiles.map((f, i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:7px 12px;background:#f8f7ff;border-radius:10px;margin-bottom:5px;border:1px solid #e9e5ff;">
      <span style="font-size:16px;">üìÑ</span>
      <span style="font-size:13px;font-weight:600;flex:1;color:#1c1c1e;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name}</span>
      <span style="font-size:11px;color:#8e8e93;white-space:nowrap;">${f.data.length} –ø–æ–∑–∏—Ü–∏–π</span>
      <button onclick="removePriceFile(${i})" style="border:none;background:none;cursor:pointer;color:#ff3b30;font-size:18px;line-height:1;padding:0 2px;flex-shrink:0;" title="–£–±—Ä–∞—Ç—å —Ñ–∞–π–ª">‚úï</button>
    </div>`).join('');
}

function removePriceFile(idx) {
  allPricesFiles.splice(idx, 1);
  renderPriceFilesList();
  const total = allPricesFiles.reduce((s, f) => s + f.data.length, 0);
  if (allPricesFiles.length === 0) {
    document.getElementById('multiPriceBox').classList.remove('loaded');
    document.getElementById('multiPriceStatus').textContent = '';
  } else {
    document.getElementById('multiPriceStatus').textContent = `‚úì ${allPricesFiles.length} —Ñ–∞–π–ª(–æ–≤) ¬∑ ${total} –ø–æ–∑–∏—Ü–∏–π`;
    performEnhancedMatching();
  }
}

function parseCSV(file) {
  return new Promise((res,rej) => { Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej}); });
}
function parseExcel(file) {
  return new Promise((res,rej) => {
    const reader=new FileReader();
    reader.onload=e=>{try{const d=new Uint8Array(e.target.result),wb=XLSX.read(d,{type:'array'}),s=wb.Sheets[wb.SheetNames[0]];res(XLSX.utils.sheet_to_json(s));}catch(err){rej(err);}};
    reader.readAsArrayBuffer(file);
  });
}
function convertTableToJSON(data) {
  const result={};if(!data||!data.length)throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
  const bc=findColumn(data,BARCODE_COLS),nc=findColumn(data,NAME_COLS),sc=findColumn(data,SYNONYM_COLS);
  if(!bc||!nc)throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏');
  for(const row of data){const b=String(row[bc]||'').trim(),n=String(row[nc]||'').trim(),s=sc?String(row[sc]||'').trim():'';if(b&&n)result[b]=[n,s];}
  return result;
}
function findColumn(data,synonyms) {
  if(!data||!data.length)return null;
  const cols=Object.keys(data[0]);
  return cols.find(c=>synonyms.some(s=>c.toLowerCase().includes(s.toLowerCase())))||cols[0];
}
function isBarcode(str) { return /^\d{8,14}$/.test(String(str).trim()); }
function showProgress(t) { document.getElementById('progressBar').classList.add('show'); document.getElementById('progressText').textContent=t; document.getElementById('progressFill').style.width='0%'; }
function updateProgress(p) { document.getElementById('progressFill').style.width=p+'%'; }
function hideProgress() { document.getElementById('progressBar').classList.remove('show'); }

// Smart Matcher state
let knownItems = [];

async function performEnhancedMatching() {
  if (allPricesFiles.length === 0) return;

  showProgress('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—Ä–∞–π—Å—ã...');
  allMatches = []; addedItems = [];
  window._activePairs = []; window._knownPairs = []; window._sameBCPairs = [];

  // ‚îÄ‚îÄ JSON-–±–∞–∑–∞: –®–ö ‚Üí –∫–ª—é—á –≥—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è ‚îÄ‚îÄ
  const bc2jsonKey   = new Map();
  const bc2groupName = new Map();
  for (const [key, val] of Object.entries(sharedData)) {
    const canonName = Array.isArray(val) ? (val[0]||'') : '';
    bc2jsonKey.set(key, key);
    bc2groupName.set(key, canonName);
    if (Array.isArray(val)) val.slice(1).forEach(syn => {
      const s = String(syn).trim();
      if (s) { bc2jsonKey.set(s, key); bc2groupName.set(s, canonName); }
    });
  }

  // ‚îÄ‚îÄ –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ ‚îÄ‚îÄ
  const allItems = [];
  for (let fi = 0; fi < allPricesFiles.length; fi++) {
    const f = allPricesFiles[fi];
    const bc = findColumn(f.data, BARCODE_COLS);
    const nc = findColumn(f.data, NAME_COLS);
    if (!bc || !nc) { alert(`–§–∞–π–ª "${f.name}": –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ –®—Ç—Ä–∏—Ö–∫–æ–¥/–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ`); continue; }
    for (const row of f.data) {
      const barcode = String(row[bc]||'').trim();
      const name    = String(row[nc]||'').trim();
      if (barcode && name) allItems.push({ barcode, name, _fileIdx: fi, _fileName: f.name });
    }
  }
  if (allItems.length === 0) { hideProgress(); return; }

  const singleFile = allPricesFiles.length === 1;

  // ‚îÄ‚îÄ –†–µ–∂–∏–º 1 —Ñ–∞–π–ª–∞: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø—Ä–∞–π—Å —Å JSON-–±–∞–∑–æ–π ‚îÄ‚îÄ
  if (singleFile) {
    const hasJson = Object.keys(sharedData).length > 0;
    if (!hasJson) {
      hideProgress();
      document.getElementById('resultsList').innerHTML = `<div class="matcher-empty">
        <div class="matcher-empty-icon">üì¶</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON –±–∞–∑—É</div>
        <div>–ü—Ä–∏ –æ–¥–Ω–æ–º –ø—Ä–∞–π—Å–µ —Å–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å JSON –±–∞–∑–æ–π —Å–∏–Ω–æ–Ω–∏–º–æ–≤</div></div>`;
      document.getElementById('resultsPanel').classList.add('show');
      return;
    }

    // –°—Ç—Ä–æ–∏–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –∏–∑ JSON (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã)
    const jsonItems = Object.entries(sharedData).map(([key, val]) => ({
      barcode: key,
      name:    Array.isArray(val) ? (val[0]||key) : key,
      _norm:   normalizeForMatch(Array.isArray(val) ? (val[0]||key) : key),
      _fileName: 'JSON –±–∞–∑–∞',
    }));
    const invIndexJson = buildInvIndex(jsonItems);

    const fn1 = allPricesFiles[0].name;
    showProgress('–°—Ä–∞–≤–Ω–∏–≤–∞—é –ø—Ä–∞–π—Å —Å JSON –±–∞–∑–æ–π...');

    for (let i = 0; i < allItems.length; i++) {
      const { barcode: barcode1, name: name1 } = allItems[i];
      const jsonKey1   = bc2jsonKey.get(barcode1);
      const matchName1 = jsonKey1 ? (bc2groupName.get(barcode1) || name1) : name1;
      const norm1      = normalizeForMatch(matchName1);

      const candidateIds = getCandidates(norm1, invIndexJson, jsonItems, 25);
      const candidates   = [];
      const seenBarcodes = new Set();

      for (const id of candidateIds) {
        const jItem = jsonItems[id];
        if (seenBarcodes.has(jItem.barcode)) continue;
        if (jItem.barcode === barcode1) continue; // —Ç–æ—Ç –∂–µ –®–ö ‚Äî –ø—Ä–æ–ø—É—Å–∫
        const r = calculateSimilarity(matchName1, jItem.name);
        if (r.score >= SIMILARITY_THRESHOLD) {
          candidates.push({ barcode: jItem.barcode, name: jItem.name, similarity: r.score, matchResult: r, _fileName: 'JSON –±–∞–∑–∞' });
          seenBarcodes.add(jItem.barcode);
        }
      }

      candidates.sort((a, b) => b.similarity - a.similarity);
      const top3 = candidates.slice(0, 3);
      const best = top3[0];
      if (!best) {
        if (i % 10 === 0) { updateProgress(i / allItems.length * 100); await new Promise(r => setTimeout(r, 0)); }
        continue;
      }

      const jsonKey2    = bc2jsonKey.get(best.barcode);
      const sameBarcode = barcode1 === best.barcode;
      const inJsonGroup = !sameBarcode && !!(jsonKey1 && jsonKey2 && jsonKey1 === jsonKey2);
      const bc1inBase   = !!jsonKey1;
      const bc2inBase   = !!jsonKey2; // –≤ —Ä–µ–∂–∏–º–µ 1 —Ñ–∞–π–ª–∞ best –≤—Å–µ–≥–¥–∞ –∏–∑ JSON, –∑–Ω–∞—á–∏—Ç bc2inBase=true

      allMatches.push({
        barcode: barcode1, name: name1, matchName1,
        supplierBarcode: best.barcode, supplierName: best.name,
        similarity: best.similarity, matchResult: best.matchResult,
        weightPenalty: false, candidates: top3,
        alreadyInBase: bc1inBase || bc2inBase,
        sameBarcode, inJsonGroup, bc1inBase,
        bc1jsonKey: jsonKey1 || null,
        bc1canonName: jsonKey1 ? bc2groupName.get(barcode1) : null,
        usedJsonName: jsonKey1 && matchName1 !== name1,
        bc2inBase,
        bc2jsonKey: jsonKey2 || null,
        bc2canonName: jsonKey2 ? bc2groupName.get(best.barcode) : null,
        _file1Name: fn1,
        _file2Name: 'JSON –±–∞–∑–∞',
      });

      if (i % 10 === 0) { updateProgress(i / allItems.length * 100); await new Promise(r => setTimeout(r, 0)); }
    }

  } else {
    // ‚îÄ‚îÄ –†–µ–∂–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –ò —Å JSON ‚îÄ‚îÄ
    const indexedAll  = allItems.map(item => ({ ...item, _norm: normalizeForMatch(item.name) }));
    const invIndexAll = buildInvIndex(indexedAll);

    // JSON-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã (–¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ JSON –∑–∞–≥—Ä—É–∂–µ–Ω)
    const hasJson = Object.keys(sharedData).length > 0;
    const jsonItems = hasJson ? Object.entries(sharedData).map(([key, val]) => ({
      barcode: key,
      name:    Array.isArray(val) ? (val[0]||key) : key,
      _norm:   normalizeForMatch(Array.isArray(val) ? (val[0]||key) : key),
      _fileIdx: -1, // –ø—Ä–∏–∑–Ω–∞–∫ JSON
      _fileName: 'JSON –±–∞–∑–∞',
    })) : [];
    const invIndexJson = hasJson ? buildInvIndex(jsonItems) : null;

    const seenPairs   = new Set();

    showProgress('–°—Ä–∞–≤–Ω–∏–≤–∞—é –ø–æ–∑–∏—Ü–∏–∏ –º–µ–∂–¥—É –ø—Ä–∞–π—Å–∞–º–∏...');

    for (let i = 0; i < allItems.length; i++) {
      const item1    = allItems[i];
      const { barcode: barcode1, name: name1, _fileIdx: fi1, _fileName: fn1 } = item1;

      const jsonKey1   = bc2jsonKey.get(barcode1);
      const matchName1 = jsonKey1 ? (bc2groupName.get(barcode1) || name1) : name1;
      const norm1      = normalizeForMatch(matchName1);

      const candidates   = [];
      const seenBarcodes = new Set();

      // –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –ø—Ä–∞–π—Å-—Ñ–∞–π–ª–æ–≤
      const candidateIds = getCandidates(norm1, invIndexAll, indexedAll, 30);
      for (const id of candidateIds) {
        const item2 = indexedAll[id];
        if (item2._fileIdx === fi1) continue;
        if (seenBarcodes.has(item2.barcode)) continue;
        const pairKey = [barcode1, item2.barcode].sort().join('|');
        if (seenPairs.has(pairKey)) continue;
        const r = calculateSimilarity(matchName1, item2.name);
        if (r.score >= SIMILARITY_THRESHOLD) {
          candidates.push({ barcode: item2.barcode, name: item2.name, similarity: r.score, matchResult: r, _fileName: item2._fileName });
          seenBarcodes.add(item2.barcode);
        }
      }

      // –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –∏–∑ JSON (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω)
      if (invIndexJson) {
        const candidateIdsJson = getCandidates(norm1, invIndexJson, jsonItems, 15);
        for (const id of candidateIdsJson) {
          const jItem = jsonItems[id];
          if (seenBarcodes.has(jItem.barcode)) continue;
          if (jItem.barcode === barcode1) continue;
          const pairKey = [barcode1, jItem.barcode].sort().join('|');
          if (seenPairs.has(pairKey)) continue;
          const r = calculateSimilarity(matchName1, jItem.name);
          if (r.score >= SIMILARITY_THRESHOLD) {
            candidates.push({ barcode: jItem.barcode, name: jItem.name, similarity: r.score, matchResult: r, _fileName: 'JSON –±–∞–∑–∞' });
            seenBarcodes.add(jItem.barcode);
          }
        }
      }

      candidates.sort((a, b) => b.similarity - a.similarity);
      const top3 = candidates.slice(0, 3);
      const best = top3[0];
      if (!best) {
        if (i % 10 === 0) { updateProgress(i / allItems.length * 100); await new Promise(r => setTimeout(r, 0)); }
        continue;
      }

      seenPairs.add([barcode1, best.barcode].sort().join('|'));

      const jsonKey2    = bc2jsonKey.get(best.barcode);
      const sameBarcode = barcode1 === best.barcode;
      const inJsonGroup = !sameBarcode && !!(jsonKey1 && jsonKey2 && jsonKey1 === jsonKey2);
      const bc1inBase   = !!jsonKey1;
      const bc2inBase   = !!jsonKey2;

      allMatches.push({
        barcode:         barcode1,
        name:            name1,
        matchName1,
        supplierBarcode: best.barcode,
        supplierName:    best.name,
        similarity:      best.similarity,
        matchResult:     best.matchResult,
        weightPenalty:   false,
        candidates:      top3,
        alreadyInBase:   bc1inBase || bc2inBase,
        sameBarcode,
        inJsonGroup,
        bc1inBase,
        bc1jsonKey:      jsonKey1 || null,
        bc1canonName:    jsonKey1 ? bc2groupName.get(barcode1) : null,
        usedJsonName:    jsonKey1 && matchName1 !== name1,
        bc2inBase,
        bc2jsonKey:      jsonKey2 || null,
        bc2canonName:    jsonKey2 ? bc2groupName.get(best.barcode) : null,
        _file1Name:      fn1,
        _file2Name:      best._fileName,
      });

      if (i % 10 === 0) { updateProgress(i / allItems.length * 100); await new Promise(r => setTimeout(r, 0)); }
    }
  } // end else (multiple files)

  const sameBCPairs = allMatches.filter(m => m.sameBarcode);
  const knownPairs  = allMatches.filter(m => m.inJsonGroup);
  const activePairs = allMatches.filter(m => !m.sameBarcode && !m.inJsonGroup);
  activePairs.sort((a, b) => b.similarity - a.similarity);

  document.getElementById('statTotal').textContent  = activePairs.length;
  document.getElementById('statSameBC').textContent = sameBCPairs.length;
  document.getElementById('statKnown').textContent  = knownPairs.length;
  document.getElementById('statAdded').textContent  = addedItems.length;
  document.getElementById('statsBar').classList.add('show');
  document.getElementById('resultsPanel').classList.add('show');
  hideProgress();

  window._activePairs = activePairs;
  window._knownPairs  = knownPairs;
  window._sameBCPairs = sameBCPairs;
  filterByView('all');
}

// =============================================================================
// –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –†–ï–ù–î–ï–†
// =============================================================================
function filterByView(view) {
  if (view !== currentView) _resultFilter = 'all';
  currentView = view;
  document.querySelectorAll('#statsBar .stat-item').forEach(el => {
    el.classList.toggle('active', el.dataset.view === view);
  });

  const active = window._activePairs  || [];
  const kp     = window._knownPairs   || [];
  const sbp    = window._sameBCPairs  || [];

  if (view === 'all') {
    document.getElementById('resultsTitle').textContent    = 'üìã –í—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è';
    document.getElementById('resultsSubtitle').textContent = `${active.length} –ø–∞—Ä ¬∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Å—Ö–æ–∂–µ—Å—Ç–∏`;
    renderResults(active);
  } else if (view === 'samebc') {
    document.getElementById('resultsTitle').textContent    = 'üîÅ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã';
    document.getElementById('resultsSubtitle').textContent = `${sbp.length} –ø–∞—Ä ‚Äî –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä –≤ –æ–±–æ–∏—Ö –ø—Ä–∞–π—Å–∞—Ö`;
    renderResults(sbp, 'samebc');
  } else if (view === 'known') {
    document.getElementById('resultsTitle').textContent    = 'üîó –£–∂–µ –≤ –±–∞–∑–µ JSON';
    document.getElementById('resultsSubtitle').textContent = `${kp.length} –ø–∞—Ä ‚Äî –æ–±–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ —É–∂–µ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ`;
    renderResults(kp, 'known');
  } else if (view === 'added') {
    document.getElementById('resultsTitle').textContent    = '‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —ç—Ç—É —Å–µ—Å—Å–∏—é';
    document.getElementById('resultsSubtitle').textContent = `${addedItems.length} –ø–∞—Ä`;
    renderResults(addedItems, 'added');
  }
}

function highlightMatches(text, mt) {
  if (!mt||!mt.size) return text; let r=text;
  for (const t of mt) { try { r=r.replace(new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi'),'<span class="highlight">$1</span>'); } catch(e){} }
  return r;
}

let _resultFilter = 'all';

// Diff-–ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–∞–º
// –£–º–Ω–∞—è diff-–ø–æ–¥—Å–≤–µ—Ç–∫–∞: –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è
// —Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî —Ç–∞–∫ "alpen gold" –∏ "–∞–ª–ø–µ–Ω –≥–æ–ª–¥" = —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ.
function diffHighlight(originalText, myNorm, otherNorm) {
  if (!originalText) return '';
  const otherSet = new Set(otherNorm.split(' ').filter(Boolean));
  // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞ –∏ –ø—Ä–æ–±–µ–ª—ã
  const parts = originalText.split(/(\s+)/);
  return parts.map(part => {
    if (/^\s+$/.test(part) || !part) return part;
    const normPart = normalizeForMatch(part);
    const toks = normPart.split(' ').filter(Boolean);
    if (!toks.length) return '<span class="tok-diff">' + part.toUpperCase() + '</span>';
    const matched = toks.some(t => t.length > 1 && otherSet.has(t));
    return '<span class="' + (matched ? 'tok-match' : 'tok-diff') + '">' + part.toUpperCase() + '</span>';
  }).join('');
}

function renderResults(items, mode='normal') {
  const container = document.getElementById('resultsList');
  const isAdded  = mode === 'added';
  const isKnown  = mode === 'known';
  const isSameBC = mode === 'samebc';
  const isReadonly = isAdded || isKnown || isSameBC;

  let filtered = items;
  if (!isReadonly) {
    if (_resultFilter === 'diff_bc') filtered = items.filter(r => r.barcode !== r.supplierBarcode && r.similarity >= 70);
    else if (_resultFilter === 'same_bc') filtered = items.filter(r => r.barcode === r.supplierBarcode);
  }

  if (!filtered.length) {
    const msgs = {
      added:  ['‚úÖ', '–ï—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', ''],
      known:  ['üîó', '–ù–µ—Ç –ø–∞—Ä –≤ –±–∞–∑–µ JSON', '–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON –∏–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –ø–∞—Ä–∞ –Ω–µ —Å–æ–≤–ø–∞–ª–∞'],
      samebc: ['üîÅ', '–û–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ –Ω–µ—Ç', ''],
      normal: ['‚úì',  '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ'],
    };
    const [icon, title, sub] = msgs[mode] || msgs.normal;
    container.innerHTML = `
      ${!isReadonly ? _filterBarHtml(items) : ''}
      <div class="matcher-empty">
        <div class="matcher-empty-icon">${icon}</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;">${title}</div>
        <div style="color:#8e8e93;font-size:13px;">${sub}</div>
      </div>`;
    return;
  }

  let html = !isReadonly ? _filterBarHtml(items) : '';

  filtered.forEach((result, index) => {
    const sim = result.similarity || 0;
    const mr  = result.matchResult || {};

    const simClass  = (isKnown || isSameBC) ? 'skip' : sim>=85?'high':sim>=60?'medium':'review';
    const cardClass = (isKnown || isSameBC || isAdded) ? 'skipped-card'
                    : sim>=85?'high-match':sim>=60?'medium-match':'review-card';

    let actionLabel, actionClass;
    if (isSameBC || result.sameBarcode) { actionLabel='üîÅ –¢–æ—Ç –∂–µ –®–ö'; actionClass='action-skip'; }
    else if (isKnown)   { actionLabel='üîó –í –±–∞–∑–µ JSON'; actionClass='action-skip'; }
    else if (isAdded)   { actionLabel='‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ'; actionClass='action-skip'; }
    else if (result.bc1inBase && result.bc2inBase) { actionLabel='üîÄ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å'; actionClass='action-merge'; }
    else if (result.bc1inBase || result.bc2inBase) { actionLabel='‚ûï –°–∏–Ω–æ–Ω–∏–º'; actionClass='action-synonym'; }
    else { actionLabel=sim>=85?'üÜï –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞':'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å'; actionClass=sim>=85?'action-main':'action-review'; }

    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è diff
    const n1 = mr._n1 || normalizeForMatch(result.name);
    const n2 = mr._n2 || normalizeForMatch(result.supplierName||'');

    // Diff-–ø–æ–¥—Å–≤–µ—Ç–∫–∞ (word-level, —Å —É—á—ë—Ç–æ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–∞)
    const hl1 = diffHighlight(result.name, n1, n2);
    const hl2 = diffHighlight(result.supplierName||'', n2, n1);

    // –¢–µ–≥–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
    const matchTags = (mr.tags||[]).filter(t => t.includes('‚ö†Ô∏è')).map(t=>`<span class="match-tag">${t}</span>`).join('');

    // Score —Å—Ç—Ä–æ–∫–∞
    let scoreHtml = '';
    if (mr.details) {
      scoreHtml = mr.details.map(d => {
        const s = d.score||0;
        if (s===0 && !d.penalty && !d.note) return '';
        const col = d.penalty ? '#ff3b30' : s>0 ? '#34c759' : '#8e8e93';
        return `<span class="score-item" style="${d.penalty?'background:#fff0f0':''}">
          <span class="score-icon">${d.component.split(' ')[0]}</span>
          <span style="color:${col}">${s>0?'+':''}${s}%</span>
        </span>`;
      }).filter(Boolean).join('');
    }

    // –ò–∫–æ–Ω–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    const src1icon = result.bc1inBase ? 'üì¶' : 'üìÑ';
    const src2icon = result._file2Name === 'JSON –±–∞–∑–∞' ? 'üì¶' : 'üè™';

    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
    let candHtml = '';
    if (result.candidates && result.candidates.length > 1 && !isReadonly) {
      const cands = result.candidates.slice(0,3).map((c,ci) => {
        const col = c.similarity>=85?'#34c759':c.similarity>=60?'#ff9500':'#af52de';
        return `<div class="candidate-item ${ci===0?'selected':''}" onclick="selectCandidate(event,${index},${ci},'${currentView}')">
          <span class="candidate-score" style="background:${col}">${c.similarity}%</span>
          <span class="candidate-name">${(c._fileName||'')?`<span style="font-size:9px;color:#a78bfa;font-weight:400;">${c._fileName} ¬∑ </span>`:''}${c.name}</span>
          <span class="candidate-bc">${c.barcode||''}</span>
          <button class="select-candidate-btn" onclick="selectAndConfirm(event,${index},${ci},'${currentView}')">‚úì</button>
        </div>`;
      }).join('');
      candHtml = `<div class="candidates-section"><div class="candidates-title">üîé –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã</div>${cands}</div>`;
    }

    // sameBC mode: show "add to JSON" button if not already in JSON
    let sameBcBtn = '';
    if ((isSameBC || result.sameBarcode) && !result.bc1inBase && !result.bc2inBase) {
      const bce = result.barcode.replace(/'/g,"\\'");
      const nme = (result.name||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');
      sameBcBtn = `<button onclick="event.stopPropagation();sameBcAddToJson('${bce}','${nme}',${index})"
        style="margin-top:6px;padding:4px 14px;background:#7c3aed;color:#fff;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;">
        üÜï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –≤ JSON
      </button>`;
    }

    const clickable = (!isReadonly || isSameBC) ? `onclick="showConfirmModal(${index},'${currentView}')"` : '';

    html += `<div class="result-card ${cardClass}" ${clickable}>
      <div class="card-header">
        <div class="card-left">
          <span class="similarity-badge similarity-${simClass}">${sim}%</span>
          ${matchTags}
        </div>
        <span class="action-badge ${actionClass}">${actionLabel}</span>
      </div>
      <table class="cmp-table">
        <tr class="cmp-row1">
          <td class="cmp-col-src"><span class="cmp-src-label">${src1icon} ${result._file1Name||'–ò—Å—Ç–æ—á–Ω–∏–∫ 1'}</span></td>
          <td class="cmp-col-name"><span class="cmp-name-text">${hl1}</span></td>
          <td class="cmp-col-bc"><span class="cmp-bc-text">${result.barcode}</span></td>
        </tr>
        <tr class="cmp-row2">
          <td class="cmp-col-src"><span class="cmp-src-label">${src2icon} ${result._file2Name||'–ò—Å—Ç–æ—á–Ω–∏–∫ 2'}</span></td>
          <td class="cmp-col-name"><span class="cmp-name-text">${hl2}</span></td>
          <td class="cmp-col-bc"><span class="cmp-bc-text">${result.supplierBarcode||'‚Äî'}</span></td>
        </tr>
      </table>
      ${scoreHtml ? `<div class="score-details">${scoreHtml}</div>` : ''}
      ${sameBcBtn}
      ${candHtml}
    </div>`;
  });

  container.innerHTML = html;
}

function _filterBarHtml(items) {
  const total  = items.length;
  const diffBc = items.filter(r => r.barcode !== r.supplierBarcode && r.similarity >= 70).length;
  const sameBc = items.filter(r => r.barcode === r.supplierBarcode).length;
  const btn = (key, label) => `<button
    style="padding:4px 12px;border-radius:20px;border:1px solid #e0e0e0;cursor:pointer;font-size:12px;
           background:${_resultFilter===key?'#1d1d1f':'#fff'};color:${_resultFilter===key?'#fff':'#1d1d1f'};
           font-weight:${_resultFilter===key?'600':'400'}"
    onclick="_resultFilter='${key}';filterByView(currentView)">${label}</button>`;
  return `<div style="display:flex;gap:6px;align-items:center;padding:8px 0 12px;flex-wrap:wrap;">
    <span style="font-size:12px;color:#8e8e93;margin-right:2px;">–§–∏–ª—å—Ç—Ä:</span>
    ${btn('all', `–í—Å–µ (${total})`)}
    ${btn('diff_bc', `–°—Ö–æ–∂–∏–µ –∏–º–µ–Ω–∞, —Ä–∞–∑–Ω—ã–µ –®–ö (${diffBc})`)}
    ${sameBc > 0 ? btn('same_bc', `–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –®–ö (${sameBc})`) : ''}
  </div>`;
}

function selectCandidate(e, itemIndex, candidateIndex, view) {
  e.stopPropagation();
  const list = window._activePairs || [];
  if (!list[itemIndex] || !list[itemIndex].candidates) return;
  const cands  = list[itemIndex].candidates;
  const chosen = cands.splice(candidateIndex, 1)[0];
  cands.unshift(chosen);
  list[itemIndex].supplierBarcode = chosen.barcode;
  list[itemIndex].supplierName    = chosen.name;
  list[itemIndex].similarity      = chosen.similarity;
  list[itemIndex].matchResult     = chosen.matchResult;
  filterByView(currentView);
}
function selectAndConfirm(e, itemIndex, candidateIndex, view) {
  e.stopPropagation();
  selectCandidate(e, itemIndex, candidateIndex, view);
  showConfirmModal(itemIndex, view);
}

// =============================================================================
// –ú–û–î–ê–õ–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
// =============================================================================
function showConfirmModal(index, view) {
  const v = view || currentView;
  const list = v === 'samebc' ? (window._sameBCPairs||[])
             : v === 'known'  ? (window._knownPairs||[])
             : v === 'added'  ? addedItems
             : (window._activePairs||[]);
  const result = list[index]; if (!result) return;
  pendingAction = { ...result };

  const sim = result.similarity || 0;
  const mr  = result.matchResult || {};
  const n1 = mr._n1 || normalizeForMatch(result.name);
  const n2 = mr._n2 || normalizeForMatch(result.supplierName||'');

  // Similarity badge color
  const pct = document.getElementById('modalSimilarity');
  pct.textContent = sim + '%';
  pct.className = 'modal-sim-pct' + (sim>=85?'':sim>=60?' med':' low');

  // Source labels
  document.getElementById('modalLabel1').textContent = 'üìÑ ' + (result._file1Name || '–ò—Å—Ç–æ—á–Ω–∏–∫ 1');
  document.getElementById('modalLabel2').textContent = (result._file2Name==='JSON –±–∞–∑–∞'?'üì¶':'üè™') + ' ' + (result._file2Name || '–ò—Å—Ç–æ—á–Ω–∏–∫ 2');

  // Barcodes
  document.getElementById('modalPriceBarcode').textContent = result.barcode;
  document.getElementById('modalMainBarcode').textContent  = result.supplierBarcode||'‚Äî';

  // Names with diff highlight
  document.getElementById('modalPriceName').innerHTML = diffHighlight(result.name, n1, n2);
  document.getElementById('modalMainName').innerHTML  = diffHighlight(result.supplierName||'', n2, n1);

  // Hide norm rows (not needed)
  document.getElementById('modalPriceNorm').innerHTML = '';
  document.getElementById('modalMainNorm').innerHTML  = '';

  // Action banner
  const aic = document.getElementById('actionInfoCompact');
  const cb  = document.getElementById('confirmBtn');
  const { bc1inBase, bc2inBase, bc1jsonKey, bc2jsonKey: bc2jk, bc1canonName, bc2canonName,
          barcode, supplierBarcode, sameBarcode } = result;

  // sameBC with no JSON match ‚Üí create new group
  if (sameBarcode || (v === 'samebc')) {
    if (!bc1inBase && !bc2inBase) {
      aic.className = 'action-info-compact main';
      document.getElementById('actionTextCompact').textContent =
        `üÜï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É: –®–ö ${barcode} ¬´${result.name}¬ª`;
      cb.textContent = 'üÜï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É';
    } else {
      aic.className = 'action-info-compact';
      document.getElementById('actionTextCompact').textContent = `üîó –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –®–ö, —É–∂–µ –≤ –±–∞–∑–µ`;
      cb.style.display = 'none';
    }
  } else if (bc1inBase && bc2inBase && bc1jsonKey !== bc2jk) {
    aic.className = 'action-info-compact merge';
    document.getElementById('actionTextCompact').textContent =
      `üîÄ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É ¬´${bc1canonName||barcode}¬ª –∏ ¬´${bc2canonName||supplierBarcode}¬ª`;
    cb.textContent = 'üîÄ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≥—Ä—É–ø–ø—ã';
    cb.style.display = '';
  } else if (!bc1inBase && bc2inBase) {
    aic.className = 'action-info-compact';
    document.getElementById('actionTextCompact').textContent =
      `‚ûï –®–ö ${barcode} ‚Üí —Å–∏–Ω–æ–Ω–∏–º –≤ –≥—Ä—É–ø–ø—É ¬´${bc2canonName||supplierBarcode}¬ª`;
    cb.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º';
    cb.style.display = '';
  } else if (bc1inBase && !bc2inBase) {
    aic.className = 'action-info-compact';
    document.getElementById('actionTextCompact').textContent =
      `‚ûï –®–ö ${supplierBarcode} ‚Üí —Å–∏–Ω–æ–Ω–∏–º –≤ –≥—Ä—É–ø–ø—É ¬´${bc1canonName||barcode}¬ª`;
    cb.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º';
    cb.style.display = '';
  } else {
    aic.className = 'action-info-compact main';
    document.getElementById('actionTextCompact').textContent =
      `üÜï –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞: –®–ö ${barcode} + —Å–∏–Ω–æ–Ω–∏–º –®–ö ${supplierBarcode}`;
    cb.textContent = 'üÜï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É';
    cb.style.display = '';
  }
  document.getElementById('confirmModal').classList.add('show');
}
function closeModal() { document.getElementById('confirmModal').classList.remove('show'); pendingAction = null; }

// –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É" –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≤–∫–ª–∞–¥–∫–∏ "–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –®–ö"
function sameBcAddToJson(barcode, name, index) {
  if (!barcode) return;
  if (!sharedData[barcode]) sharedData[barcode] = [name || barcode];
  // Remove from sameBCPairs list
  const sbp = window._sameBCPairs || [];
  if (index >= 0 && index < sbp.length) sbp.splice(index, 1);
  document.getElementById('statSameBC').textContent = sbp.length;
  notifyChange(); editorRefreshDerivedState();
  filterByView(currentView);
}

function confirmAction() {
  if (!pendingAction) return;
  const { barcode, name, supplierBarcode, supplierName, bc1inBase, bc2inBase, bc1jsonKey,
          bc2jsonKey: bc2jk, sameBarcode } = pendingAction;

  // sameBC with no JSON match ‚Üí create new group (just the single barcode+name)
  if (sameBarcode && !bc1inBase && !bc2inBase) {
    if (!sharedData[barcode]) sharedData[barcode] = [name || barcode];
    const sbp = window._sameBCPairs || [];
    const idx2 = sbp.findIndex(r => r.barcode === barcode);
    if (idx2 >= 0) sbp.splice(idx2, 1);
    document.getElementById('statSameBC').textContent = sbp.length;
    notifyChange(); editorRefreshDerivedState();
    closeModal(); filterByView(currentView); return;
  }

  if (bc1inBase && bc2inBase && bc1jsonKey !== bc2jk) {
    // –°–ª–∏—è–Ω–∏–µ –¥–≤—É—Ö JSON-–≥—Ä—É–ø–ø: –≤—Å—ë –∏–∑ bc2jk –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ bc1jsonKey, bc2jk —É–¥–∞–ª—è–µ–º
    const arr1 = sharedData[bc1jsonKey] || [];
    const arr2 = sharedData[bc2jk]     || [];
    const allBarcodes = new Set([bc1jsonKey, ...arr1.slice(1), bc2jk, ...arr2.slice(1)].map(s=>String(s).trim()).filter(Boolean));
    allBarcodes.delete(bc1jsonKey); // –≥–ª–∞–≤–Ω—ã–π –∫–ª—é—á –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Å–∏–Ω–æ–Ω–∏–º
    sharedData[bc1jsonKey] = [arr1[0] || arr2[0] || '', ...allBarcodes];
    delete sharedData[bc2jk];

  } else if (!bc1inBase && bc2inBase) {
    // barcode –∏–∑ –ø—Ä–∞–π—Å–∞ ‚Üí —Å–∏–Ω–æ–Ω–∏–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é JSON-–≥—Ä—É–ø–ø—É bc2jk
    const arr = sharedData[bc2jk];
    if (arr) {
      const syns = arr.slice(1).map(s=>String(s).trim()).filter(Boolean);
      if (!syns.includes(barcode)) sharedData[bc2jk] = [arr[0]||'', ...syns, barcode];
    }

  } else if (bc1inBase && !bc2inBase) {
    // supplierBarcode –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø—Ä–∞–π—Å–∞ ‚Üí —Å–∏–Ω–æ–Ω–∏–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é JSON-–≥—Ä—É–ø–ø—É bc1jsonKey
    const arr = sharedData[bc1jsonKey];
    if (arr) {
      const syns = arr.slice(1).map(s=>String(s).trim()).filter(Boolean);
      if (!syns.includes(supplierBarcode)) sharedData[bc1jsonKey] = [arr[0]||'', ...syns, supplierBarcode];
    }

  } else {
    // –ù–∏ –æ–¥–∏–Ω –Ω–µ –≤ JSON ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
    if (!sharedData[barcode]) {
      sharedData[barcode] = [name, supplierBarcode];
    } else {
      // barcode —É–∂–µ –µ—Å—Ç—å (–¥–æ–±–∞–≤–∏–ª–∏ —Ä–∞–Ω—å—à–µ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏) ‚Äî –¥–æ–ø–∏—Å—ã–≤–∞–µ–º —Å–∏–Ω–æ–Ω–∏–º
      const syns = sharedData[barcode].slice(1).map(s=>String(s).trim()).filter(Boolean);
      if (!syns.includes(supplierBarcode)) sharedData[barcode] = [sharedData[barcode][0]||name, ...syns, supplierBarcode];
    }
  }

  const active = window._activePairs || [];
  const idx = active.findIndex(r => r.barcode === barcode && r.supplierBarcode === supplierBarcode);
  if (idx >= 0) active.splice(idx, 1);
  addedItems.unshift(pendingAction);

  document.getElementById('statTotal').textContent = active.length;
  document.getElementById('statAdded').textContent = addedItems.length;

  notifyChange();
  editorRefreshDerivedState();
  closeModal();
  filterByView(currentView);
}

// =============================================================================
// ===== –†–ï–î–ê–ö–¢–û–† –°–ò–ù–û–ù–ò–ú–û–í =====
// =============================================================================

// DOM refs
const editorSearchInput = document.getElementById('searchInput');
const editorExportExcelBtn = document.getElementById('exportExcelBtn');
const editorImportExcelBtn = document.getElementById('importExcelBtn');
const editorClearBtn = document.getElementById('clearBtn');
const editorExcelImportInput = document.getElementById('excelImportInput');
const editorGroupsContainer = document.getElementById('groupsContainer');
const editorInfoPanel = document.getElementById('editorInfoPanel');
const editorNewMainBarcodeEl = document.getElementById('newMainBarcode');
const editorNewGroupNameEl = document.getElementById('newGroupName');
const editorNewSynonymsEl = document.getElementById('newSynonyms');
const editorCreateGroupBtn = document.getElementById('createGroupBtn');
const editorClearNewGroupBtn = document.getElementById('clearNewGroupBtn');

// ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ
function normBC(v){return String(v??'').trim();}
function normName(v){return String(v??'').trim();}
function splitSyns(text){const r=String(text??'').trim();return r?r.split(',').map(s=>s.trim()).filter(Boolean):[];}
function safeId(str){try{return btoa(unescape(encodeURIComponent(String(str??'')))).replaceAll('=','').replaceAll('+','-').replaceAll('/','_');}catch(e){return String(str).replace(/[^a-zA-Z0-9_-]/g,'_');}}
function escH(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function escV(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');}
function enc(s){return encodeURIComponent(String(s??''));}
function dec(s){return decodeURIComponent(String(s??''));}
function bcLookupUrl(bc){return'https://barcode-list.ru/barcode/RU/%D0%9F%D0%BE%D0%B8%D1%81%D0%BA.htm?barcode='+encodeURIComponent(normBC(bc));}
function openBcLookup(bc){const w=window.open(bcLookupUrl(bc),'_blank');try{if(w)w.opener=null;}catch(e){}}

// ‚îÄ‚îÄ‚îÄ save dialog ‚îÄ‚îÄ‚îÄ
async function editorSaveDialog(blob,name,mime,ext,desc){
  if(document.activeElement?.blur)document.activeElement.blur();
  if('showSaveFilePicker' in window){try{const h=await window.showSaveFilePicker({suggestedName:name,types:[{description:desc,accept:{[mime]:[ext]}}]});const w=await h.createWritable();await w.write(blob);await w.close();return;}catch(e){if(e?.name==='AbortError')return;}}
  saveAs(blob,name);
}

// ‚îÄ‚îÄ‚îÄ embedded data ‚îÄ‚îÄ‚îÄ
function editorTryLoadEmbedded(){
  const el=document.getElementById('embeddedData');
  if(!el)return false;
  const txt=(el.textContent||'').trim();
  if(!txt||txt==='{}')return false;
  try{const d=JSON.parse(txt);if(d&&typeof d==='object'){sharedData=d;return true;}}catch(e){}
  return false;
}

// ‚îÄ‚îÄ‚îÄ conflicts ‚îÄ‚îÄ‚îÄ
function editorComputeConflicts(data){
  const cg=new Set(),b2g=new Map();
  for(const mb of Object.keys(data)){
    const arr=data[mb],all=[mb,...(arr||[]).slice(1)];
    for(const bc of all){const b=normBC(bc);if(!b)continue;if(!b2g.has(b))b2g.set(b,new Set());b2g.get(b).add(mb);}
  }
  for(const s of b2g.values())if(s.size>1)for(const g of s)cg.add(g);
  return cg;
}

function editorRefreshDerivedState(){
  editorConflicts=editorComputeConflicts(sharedData);
  editorUpdateUI();
  editorRenderGroups();
}

// ‚îÄ‚îÄ‚îÄ new group ‚îÄ‚îÄ‚îÄ
function editorClearNewGroupInputs(){editorNewMainBarcodeEl.value='';editorNewGroupNameEl.value='';editorNewSynonymsEl.value='';editorNewGroupNameEl.focus();}
function editorSaveNewGroup(){
  const mb=normBC(editorNewMainBarcodeEl.value),gn=normName(editorNewGroupNameEl.value),st=editorNewSynonymsEl.value;
  if(!mb){alert('–í–≤–µ–¥–∏—Ç–µ –≥–ª–∞–≤–Ω—ã–π —à—Ç—Ä–∏—Ö–∫–æ–¥');return;}
  if(sharedData[mb]){alert('–¢–∞–∫–∞—è –≥—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');return;}
  sharedData[mb]=[gn,...splitSyns(st)];
  editorClearNewGroupInputs();
  notifyChange();
  editorRefreshDerivedState();
}

// ‚îÄ‚îÄ‚îÄ row operations ‚îÄ‚îÄ‚îÄ
function editorApplyRenameAndName(oldMain,newMain,newName){
  const ok=normBC(oldMain),nk=normBC(newMain);
  if(!sharedData[ok])return null;
  if(!nk){alert('–ì–ª–∞–≤–Ω—ã–π –®–ö –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');return null;}
  let ak=ok;
  if(nk!==ok){if(sharedData[nk]){alert('–ì—Ä—É–ø–ø–∞ —Å —Ç–∞–∫–∏–º –®–ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');return null;}sharedData[nk]=sharedData[ok];delete sharedData[ok];ak=nk;}
  sharedData[ak][0]=normName(newName);
  return ak;
}
function editorSaveRowFromEl(rowEl,oldMain,opts){
  const ne=rowEl.querySelector('input[data-role="name"]'),me=rowEl.querySelector('input[data-role="main"]'),se=rowEl.querySelector('input[data-role="newSyn"]');
  const newName=normName(ne?ne.value:''),newMain=normBC(me?me.value:oldMain),newSyn=normBC(se?se.value:'');
  const ak=editorApplyRenameAndName(oldMain,newMain,newName);
  if(!ak)return null;
  if(!opts?.skipNewSyn&&newSyn){const arr=sharedData[ak],ex=new Set(arr.slice(1));if(!ex.has(newSyn))arr.push(newSyn);if(se)se.value='';}
  return ak;
}
function editorDeleteGroup(key){const k=normBC(key);if(!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ${k}?`))return;delete sharedData[k];notifyChange();editorRefreshDerivedState();}
function editorRemoveSynonym(key,syn){const k=normBC(key);if(!sharedData[k])return;const s=normBC(syn),arr=sharedData[k],i=arr.indexOf(s);if(i>=1)arr.splice(i,1);notifyChange();editorRefreshDerivedState();}

// ‚îÄ‚îÄ‚îÄ render ‚îÄ‚îÄ‚îÄ
function editorRenderGroups(){
  const keys=Object.keys(sharedData);
  if(!keys.length){
    editorGroupsContainer.innerHTML=`<div class="editor-empty"><div class="editor-empty-icon">üìÑ</div><h3>–ü—É—Å—Ç–æ</h3><p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É.</p></div>`;
    return;
  }
  let groups=keys;
  if(editorSearchQuery){
    groups=groups.filter(mb=>{const arr=sharedData[mb]||[''];const name=String(arr[0]||'').toLowerCase();const syns=(arr.slice(1)||[]).map(s=>String(s).toLowerCase());return String(mb).toLowerCase().includes(editorSearchQuery)||name.includes(editorSearchQuery)||syns.some(s=>s.includes(editorSearchQuery));});
  }
  groups.sort((a,b)=>{const na=String((sharedData[a]||[''])[0]).toLowerCase(),nb=String((sharedData[b]||[''])[0]).toLowerCase();if(na<nb)return -1;if(na>nb)return 1;return a<b?-1:a>b?1:0;});
  if(!groups.length){editorGroupsContainer.innerHTML=`<div class="editor-empty"><div class="editor-empty-icon">üîé</div><h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</p></div>`;return;}
  let html='';
  for(const mb of groups){
    const arr=sharedData[mb]||[''],name=arr[0]||'',syns=arr.slice(1)||[],hc=editorConflicts.has(mb),safe=safeId(mb);
    html+=`<div class="editor-row ${hc?'has-conflict':''}" id="erow-${safe}" data-main="${enc(mb)}"><div class="editor-grid">
      <input class="inp inp-name" type="text" data-role="name" value="${escV(name)}" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" />
      <div class="main-cell"><input class="inp inp-mono" type="text" data-role="main" value="${escV(mb)}" placeholder="–ì–ª–∞–≤–Ω—ã–π –®–ö" /><a class="loupe-link" href="${escV(bcLookupUrl(mb))}" target="_blank" rel="noopener" data-action="openLookupMain" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –®–ö">üîç</a></div>
      <div class="synonyms-cell" title="${escV(syns.join(', '))}">
        ${syns.map(syn=>`<span class="synonym-pill syn-link" role="link" tabindex="0" data-action="openLookupSyn" data-barcode="${enc(syn)}" title="${escV(syn)}">${escH(syn)}<button class="synonym-remove" type="button" data-action="removeSyn" data-main="${enc(mb)}" data-syn="${enc(syn)}" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></span>`).join('')}
      </div>
      <input class="inp inp-mono" type="text" data-role="newSyn" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º" />
      <button class="btn btn-success btn-disk" type="button" data-action="saveRow" data-main="${enc(mb)}" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
      <button class="btn btn-danger btn-del" type="button" data-action="deleteGroup" data-main="${enc(mb)}" title="–£–¥–∞–ª–∏—Ç—å">–£–¥–∞–ª–∏—Ç—å</button>
    </div></div>`;
  }
  editorGroupsContainer.innerHTML=html;
}

// ‚îÄ‚îÄ‚îÄ delegated events ‚îÄ‚îÄ‚îÄ
editorGroupsContainer.addEventListener('click', e=>{
  const rm=e.target.closest('button[data-action="removeSyn"]');
  if(rm){const main=dec(rm.dataset.main),rowEl=rm.closest('.editor-row');if(!rowEl)return;const ak=editorSaveRowFromEl(rowEl,main,{skipNewSyn:true});if(!ak)return;editorRemoveSynonym(ak,dec(rm.dataset.syn));return;}
  const btn=e.target.closest('button[data-action]');
  if(btn){const action=btn.dataset.action,main=dec(btn.dataset.main),rowEl=btn.closest('.editor-row');if(!rowEl)return;
    if(action==='saveRow'){const ak=editorSaveRowFromEl(rowEl,main,{skipNewSyn:false});if(ak){notifyChange();editorRefreshDerivedState();}return;}
    if(action==='deleteGroup'){const ak=editorSaveRowFromEl(rowEl,main,{skipNewSyn:true});if(!ak)return;editorDeleteGroup(ak);return;}
  }
  const loupe=e.target.closest('a[data-action="openLookupMain"]');
  if(loupe){e.preventDefault();const rowEl=loupe.closest('.editor-row');if(!rowEl)return;const mi=rowEl.querySelector('input[data-role="main"]');openBcLookup(mi?mi.value:dec(rowEl.dataset.main));return;}
  const syn=e.target.closest('[data-action="openLookupSyn"]');
  if(syn){openBcLookup(dec(syn.dataset.barcode));return;}
});
editorGroupsContainer.addEventListener('keydown', e=>{
  const sp=e.target.closest('[data-action="openLookupSyn"]');
  if(sp&&(e.key==='Enter'||e.key===' ')){e.preventDefault();openBcLookup(dec(sp.dataset.barcode));return;}
  const inp=e.target.closest('input[data-role="newSyn"]');
  if(!inp||e.key!=='Enter')return;
  e.preventDefault();const rowEl=inp.closest('.editor-row');if(!rowEl)return;
  const main=dec(rowEl.dataset.main),ak=editorSaveRowFromEl(rowEl,main,{skipNewSyn:false});
  if(ak){notifyChange();editorRefreshDerivedState();}
});

// autosave
const editorAutosaveTimers=new WeakMap();
function editorDebounce(rowEl,fn,delay){if(!rowEl)return;if(editorAutosaveTimers.has(rowEl))clearTimeout(editorAutosaveTimers.get(rowEl));editorAutosaveTimers.set(rowEl,setTimeout(fn,delay));}
editorGroupsContainer.addEventListener('input', e=>{
  const ni=e.target.closest('input[data-role="name"]');if(!ni)return;
  const rowEl=ni.closest('.editor-row');if(!rowEl)return;
  const main=normBC(dec(rowEl.dataset.main));if(!sharedData[main])return;
  editorDebounce(rowEl,()=>{if(!sharedData[main])return;sharedData[main][0]=normName(ni.value);},250);
});
editorGroupsContainer.addEventListener('keydown', e=>{
  const mi=e.target.closest('input[data-role="main"]');if(!mi||e.key!=='Enter')return;e.preventDefault();mi.blur();
});
editorGroupsContainer.addEventListener('blur', e=>{
  const mi=e.target.closest('input[data-role="main"]');
  if(mi){const rowEl=mi.closest('.editor-row');if(!rowEl)return;const om=dec(rowEl.dataset.main);const ak=editorSaveRowFromEl(rowEl,om,{skipNewSyn:true});if(ak){notifyChange();editorRefreshDerivedState();}return;}
  const ni=e.target.closest('input[data-role="newSyn"]');
  if(ni){const rowEl=ni.closest('.editor-row');if(!rowEl)return;const v=normBC(ni.value);if(!v)return;const om=dec(rowEl.dataset.main);const ak=editorSaveRowFromEl(rowEl,om,{skipNewSyn:false});if(ak){notifyChange();editorRefreshDerivedState();}return;}
},true);

// ‚îÄ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ
function editorUpdateUI(){
  const has=sharedData&&Object.keys(sharedData).length>0;
  editorSearchInput.disabled=!has;
  editorExportExcelBtn.disabled=!has;
  editorClearBtn.disabled=!has;
  if(!has){editorInfoPanel.style.display='none';['groupCount','synonymCount','barcodeCount','conflictCount'].forEach(id=>document.getElementById(id).textContent='0');return;}
  editorInfoPanel.style.display='grid';
  let gcount=Object.keys(sharedData).length,scount=0;
  const allbc=new Set();
  for(const mb of Object.keys(sharedData)){allbc.add(mb);const a=sharedData[mb]||[''];const s=a.slice(1)||[];scount+=s.length;for(const x of s)allbc.add(x);}
  document.getElementById('groupCount').textContent=String(gcount);
  document.getElementById('synonymCount').textContent=String(scount);
  document.getElementById('barcodeCount').textContent=String(allbc.size);
  document.getElementById('conflictCount').textContent=String(editorConflicts.size);
}

// ‚îÄ‚îÄ‚îÄ Excel export ‚îÄ‚îÄ‚îÄ
async function editorExportExcel(){
  const wb=new ExcelJS.Workbook(),ws=wb.addWorksheet('Synonyms');
  ws.addRow(['–ì–ª–∞–≤–Ω—ã–π –®–ö','–ö–∞—Ç–µ–≥–æ—Ä–∏—è','–°–∏–Ω–æ–Ω–∏–º—ã']);
  Object.keys(sharedData).forEach(mb=>{const a=sharedData[mb]||[''];ws.addRow([mb,a[0]||'',(a.slice(1)||[]).join(', ')]);});
  ws.columns.forEach((c,i)=>{c.width=i===0?22:i===1?40:60;});
  const hr=ws.getRow(1);hr.font={bold:true};hr.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE0E0E0'}};
  ws.eachRow(r=>{r.eachCell(c=>{c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};});});
  const buf=await wb.xlsx.writeBuffer();
  const now=new Date(),ts=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  await editorSaveDialog(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),`synonyms-${ts}.xlsx`,'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','.xlsx','Excel');
}

// ‚îÄ‚îÄ‚îÄ Excel import ‚îÄ‚îÄ‚îÄ
function editorHandleExcelImport(e){
  const file=e.target.files?.[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{try{
    const data=new Uint8Array(ev.target.result),wb=XLSX.read(data,{type:'array'}),fs=wb.Sheets[wb.SheetNames[0]],rows=XLSX.utils.sheet_to_json(fs,{header:1});
    if(!rows||rows.length<2){alert('Excel –ø—É—Å—Ç–æ–π');return;}
    rows.slice(1).forEach(row=>{const mb=normBC(row?.[0]),name=normName(row?.[1]),sr=String(row?.[2]??'').trim();if(!mb)return;const syns=sr?sr.split(',').map(s=>s.trim()).filter(Boolean):[];if(!sharedData[mb]){sharedData[mb]=[name,...syns];return;}const arr=sharedData[mb];if(name)arr[0]=name;const ex=new Set(arr.slice(1));syns.forEach(s=>{if(!ex.has(s)){arr.push(s);ex.add(s);}});});
    alert('–ò–º–ø–æ—Ä—Ç Excel –∑–∞–≤–µ—Ä—à—ë–Ω.');notifyChange();editorRefreshDerivedState();
  }catch(err){console.error(err);alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Excel.');}finally{editorExcelImportInput.value='';}};
  reader.onerror=()=>{alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel.');editorExcelImportInput.value='';};
  reader.readAsArrayBuffer(file);
}

// ‚îÄ‚îÄ‚îÄ clear ‚îÄ‚îÄ‚îÄ
function editorClearAll(){if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?'))return;sharedData={};editorConflicts=new Set();editorSearchQuery='';editorExcelImportInput.value='';editorSearchInput.value='';setGlobalJsonStatus('','–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');document.getElementById('globalChangesBadge').classList.remove('show');document.getElementById('jsonStatusBox').classList.remove('loaded');document.getElementById('matcherJsonStatus').textContent='–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';document.getElementById('matcherJsonStatus').style.color='#8e8e93';editorClearNewGroupInputs();changesCount=0;editorRefreshDerivedState();}

// ‚îÄ‚îÄ‚îÄ wiring ‚îÄ‚îÄ‚îÄ
editorSearchInput.addEventListener('input', e=>{editorSearchQuery=(e.target.value||'').toLowerCase().trim();editorRenderGroups();});
editorExportExcelBtn.addEventListener('click', editorExportExcel);
editorImportExcelBtn.addEventListener('click', ()=>editorExcelImportInput.click());
editorExcelImportInput.addEventListener('change', editorHandleExcelImport);
editorClearBtn.addEventListener('click', editorClearAll);
editorCreateGroupBtn.addEventListener('click', editorSaveNewGroup);
editorClearNewGroupBtn.addEventListener('click', editorClearNewGroupInputs);
[editorNewGroupNameEl, editorNewMainBarcodeEl, editorNewSynonymsEl].forEach(el=>{el.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();editorSaveNewGroup();}});});

// Modal backdrop
document.getElementById('confirmModal').addEventListener('click', function(e){if(e.target===this)closeModal();});

// Nav active state
(function(){const href=location.href;document.querySelectorAll('.global-nav__link').forEach(a=>{const m=a.getAttribute('data-match')||'';if(m&&href.includes(m))a.classList.add('is-active');});})();

// ‚îÄ‚îÄ‚îÄ init ‚îÄ‚îÄ‚îÄ
(function init(){
  const loaded=editorTryLoadEmbedded();
  if(loaded){
    setGlobalJsonStatus('ok',`‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ HTML: ${Object.keys(sharedData).length} –∑–∞–ø–∏—Å–µ–π`);
    onSharedDataLoaded();
  } else {
    editorRefreshDerivedState();
  }
})();
</script>
</body>
</html>
